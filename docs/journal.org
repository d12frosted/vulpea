#+TITLE: Vulpea Journal Module
#+AUTHOR: Boris Buliga

The journal module provides daily notes with a two-pane interface, widgets, and calendar integration.

* Quick Start

#+begin_src emacs-lisp
;; Load the module
(require 'vulpea-journal)

;; Optional: load built-in widgets
(require 'vulpea-journal-widgets)

;; Open today's journal
(vulpea-journal)
#+end_src

Or interactively: =M-x vulpea-journal=

* Configuration

All journal settings are in a single template variable:

#+begin_src emacs-lisp
(setq vulpea-journal-default-template
      '(:file-name "journal/%Y%m%d.org"
        :title "%Y-%m-%d %A"
        :tags ("journal" "daily")
        :head "#+created: %<[%Y-%m-%d]>"
        :body "* Morning\n\n* Evening\n"))
#+end_src

** Template Parameters

| Parameter     | Required | Description                            |
|---------------+----------+----------------------------------------|
| =:file-name=  | yes      | File path (strftime format)            |
| =:title=      | yes      | Note title (strftime format)           |
| =:tags=       | yes      | Tags list (first tag identifies journal notes) |
| =:head=       | no       | Content after =#+title:=               |
| =:body=       | no       | Note body content                      |
| =:properties= | no       | Alist for property drawer              |
| =:meta=       | no       | Alist for metadata                     |

** Dynamic Templates

Use a function for date-dependent configuration:

#+begin_src emacs-lisp
(setq vulpea-journal-default-template
      (lambda (date)
        (list :file-name (format-time-string "journal/%Y/%m/%Y%m%d.org" date)
              :title (format-time-string "%Y-%m-%d %A" date)
              :tags '("journal"))))
#+end_src

** Template Syntax

- =:file-name= and =:title= use strftime format (=%Y=, =%m=, =%d=, =%A=, etc.)
- Other fields use vulpea's expansion syntax (=%<format>=, =%(elisp)=, =${var}=)

* Two-Pane Interface

The journal opens in a two-window layout:

- *Left pane*: Org buffer for editing the daily note
- *Right pane*: Widgets buffer showing contextual information

** Navigation Keys

In the widgets buffer:

| Key         | Action                 |
|-------------+------------------------|
| =n= / =p=   | Next / previous widget |
| =TAB=       | Toggle widget collapse |
| =<=         | Previous day           |
| =>=         | Next day               |
| =t=         | Jump to today          |
| =j=         | Jump to specific date  |
| =C=         | Open calendar          |
| =q=         | Quit journal view      |

* Widgets

Widgets display contextual information in the right pane.

** Enabling Widgets

#+begin_src emacs-lisp
(setq vulpea-journal-widgets
      '(calendar created-today links-to-today previous-years))
#+end_src

Widgets appear in the order listed.

** Built-in Widgets

*** Calendar

A compact month calendar highlighting days with journal entries:

#+begin_src emacs-lisp
;; Week start: 0 = Sunday, 1 = Monday
(setq vulpea-journal-widget-calendar-week-start 1)
#+end_src

Click any day to navigate to that date's journal.

*** Created Today

Lists notes created on the current journal date:

#+begin_src emacs-lisp
;; Exclude journal notes from the list
(setq vulpea-journal-widget-created-today-exclude-journal t)
#+end_src

*** Links to Today

Shows notes that link to the current journal entry (backlinks).

*** Previous Years

Displays journal entries from the same date in previous years:

#+begin_src emacs-lisp
;; Years to look back
(setq vulpea-journal-widget-previous-years-count 5)

;; Characters in preview
(setq vulpea-journal-widget-previous-years-preview-chars 200)

;; Handle leap years (Feb 29 / Mar 1)
(setq vulpea-journal-widget-previous-years-handle-leap-year t)
#+end_src

* Creating Custom Widgets

Define widgets using the =vulpea-journal-define-widget= macro:

#+begin_src emacs-lisp
(require 'vulpea-journal-widget)

(vulpea-journal-define-widget my-tasks
  :title "Tasks Due Today"
  :order 25
  :collapsible t
  :default-collapsed nil
  :query #'my-tasks-query
  :render #'my-tasks-render
  :empty-message "No tasks due today")

(defun my-tasks-query (date)
  "Return tasks due on DATE."
  (vulpea-db-query
   (lambda (note)
     (when-let ((deadline (vulpea-note-deadline note)))
       (equal (format-time-string "%Y-%m-%d" date)
              (format-time-string "%Y-%m-%d" deadline))))))

(defun my-tasks-render (note)
  "Render NOTE as a task item."
  (concat "â€¢ " (vulpea-note-title note) "\n"))
#+end_src

** Widget Properties

| Property            | Description                    | Default    |
|---------------------+--------------------------------+------------|
| =:title=            | Display title                  | (required) |
| =:order=            | Display order (lower = earlier) | 50         |
| =:collapsible=      | Can be collapsed               | t          |
| =:default-collapsed= | Start collapsed               | nil        |
| =:query=            | Function =(date) -> list=      | (required) |
| =:render=           | Function =(item) -> string=    | (required) |
| =:empty-message=    | Shown when query returns nil   | "No items" |
| =:keymap=           | Widget-specific keybindings    | nil        |

* Calendar Integration

Vulpea can highlight journal dates in Emacs calendar:

#+begin_src emacs-lisp
;; Enable calendar marking
(setq vulpea-journal-calendar-mark-entries t)

;; Face for marked days
(setq vulpea-journal-calendar-entry-face 'diary-face)
#+end_src

Press =j= in the calendar to open that day's journal.

* API Reference

** Opening Journal

#+begin_src emacs-lisp
;; Today
(vulpea-journal)
(vulpea-journal-today)

;; Specific date
(vulpea-journal (encode-time 0 0 12 25 12 2024))
#+end_src

** Working with Journal Notes

#+begin_src emacs-lisp
;; Get or create note for date
(vulpea-journal-note date)

;; Find existing note (nil if none)
(vulpea-journal-find-note date)

;; Check if note is a journal entry
(vulpea-journal-note-p note)
#+end_src

** Navigation

#+begin_src emacs-lisp
(vulpea-journal-goto-date date)
(vulpea-journal-goto-next-day)
(vulpea-journal-goto-prev-day)
#+end_src

** Querying Journal Dates

#+begin_src emacs-lisp
;; Dates with journals in a month
(vulpea-journal-dates-in-month year month)

;; Dates with journals in a range
(vulpea-journal-dates-in-range start-date end-date)
#+end_src

** Widgets

#+begin_src emacs-lisp
;; Refresh widgets display
(vulpea-journal-refresh-widgets)
#+end_src

* Example Configuration

#+begin_src emacs-lisp
(require 'vulpea-journal)
(require 'vulpea-journal-widgets)

;; Journal template
(setq vulpea-journal-default-template
      '(:file-name "journal/%Y/%Y%m%d.org"
        :title "%Y-%m-%d %A"
        :tags ("journal")
        :body "* Morning Reflection\n\n* Work\n\n* Evening\n"))

;; Widgets to display
(setq vulpea-journal-widgets
      '(calendar created-today links-to-today previous-years))

;; Widget settings
(setq vulpea-journal-widget-calendar-week-start 1)  ; Monday
(setq vulpea-journal-widget-previous-years-count 3)

;; Calendar integration
(setq vulpea-journal-calendar-mark-entries t)

;; Keybinding
(global-set-key (kbd "C-c j") #'vulpea-journal)
#+end_src

* Next Steps

- [[file:api-reference.org][API Reference]] - Full API documentation
- [[file:plugin-guide.org][Plugin Guide]] - Custom extractors
