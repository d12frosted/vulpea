#+TITLE: Vulpea v2 Usage Analysis
#+AUTHOR: Analysis of vino and d12frosted/environment
#+DATE: 2025-11-16

* Overview

This document analyzes two major consumers of the vulpea library to ensure v2 architecture supports all critical use cases:

1. **vino** - Wine cellar management system
2. **d12frosted/environment** - Personal Emacs configuration with 10k+ notes

* Analysis: vino (Wine Cellar Management)

** Repository
https://github.com/d12frosted/vino

** Critical Vulpea Dependencies

*** Core Query Operations
| Function | Usage | Frequency | Purpose |
|---|---|---|---|
| =vulpea-db-query-by-tags-every= | Primary filter | Very High | Filter wine entries, ratings, producers, regions |
| =vulpea-db-query-by-tags-some= | Secondary filter | Medium | Alternative filtering |
| =vulpea-db-get-by-id= | Note retrieval | High | Load wine/rating details |
| =vulpea-select-from= | User interaction | High | Interactive note selection |
| =vulpea-select-multiple-from= | Grape selection | Medium | Multi-select for grapes |

*** Tag-Based Queries (Critical Pattern)
#+begin_src elisp
;; Wine entries
(vulpea-db-query-by-tags-every '("wine" "cellar"))

;; Ratings
(vulpea-db-query-by-tags-every '("wine" "rating"))

;; Geographic filtering
(vulpea-db-query-by-tags-every '("wine" "region"))
(vulpea-db-query-by-tags-every '("wine" "appellation"))
(vulpea-db-query-by-tags-every '("wine" "producer"))
#+end_src

*** Metadata Operations (Heavy Usage)
| Function | Purpose | Type Coercion |
|---|---|---|
| =vulpea-note-meta-get= | Single value retrieval | 'note, 'number, 'link |
| =vulpea-note-meta-get-list= | List retrieval | Same as above |
| =vulpea-buffer-meta-set= | Write metadata | With 'append mode |
| =vulpea-buffer-meta-sort= | Organize metadata | Custom order |

*** Metadata Schemas Used

**** Wine Entry
#+begin_example
carbonation, carbonation method, colour, sweetness, producer,
name, vintage, base, sur lie, degorgee, volume, country, region,
appellation, grapes, alcohol, sugar, price, acquired, consumed,
available, rating, ratings (list of note links)
#+end_example

**** Rating
#+begin_example
wine (note link), date, version, [dynamic score fields],
score, score_max, total
#+end_example

**** Geographic Hierarchy
#+begin_example
Country: [title only]
Region: country (note link), parent (optional region link)
Appellation: country (note link), parent (region link)
#+end_example

*** Note Creation Pattern
#+begin_src elisp
(vulpea-create
 title
 file-name-template
 :immediate-finish t
 :unnarrowed t
 :tags tags
 :head head
 :body body
 :meta meta
 :context context
 :properties properties)
#+end_src

** Performance Requirements
- Must handle hundreds of wine entries efficiently
- Queries by tags need to be <100ms for responsive UI
- Meta operations are frequent (on every rating)
- Bidirectional links (wine ↔ ratings) must stay in sync

** V2 Compatibility Assessment

✅ **SUPPORTED**
- Tag-based queries (query-by-tags-every/some)
- Metadata get/set operations
- Note creation with templates
- Note selection UI

⚠️ **REQUIRES ATTENTION**
- Type coercion in metadata ('note, 'number, 'link) - must preserve
- Metadata sorting API - must preserve
- Immediate finish + metadata manipulation - workflow must work

❌ **MISSING (but not used by vino)**
- Custom database tables (vino doesn't define any)

* Analysis: d12frosted/environment (Personal Configuration)

** Repository
https://github.com/d12frosted/environment/tree/master/emacs

** Scale
- 10,000+ org files
- Multiple note types: projects, areas, people, wine, journal
- Heavy agenda usage

** Critical Vulpea Dependencies

*** Custom Query Functions (lib-vulpea.el)
#+begin_src elisp
;; Exclude specific note types from completion
(defun vulpea-find-candidates ()
  (vulpea-db-query-by-tags-none
   '("cellar" "rating" "appellation" "grape" "region" "cemetery")))

(defun vulpea-insert-candidates ()
  (vulpea-db-query-by-tags-none
   '("cellar" "rating" "appellation" "grape" "region")))

;; Area selection
(vulpea-db-query-by-tags-every '("area"))

;; Project selection
(vulpea-db-query-by-tags-every '("project"))
#+end_src

*** Dynamic Agenda Files (lib-vulpea-agenda.el)
#+begin_src elisp
(defun vulpea-agenda-files-update ()
  "Update org-agenda-files from database query."
  (setq org-agenda-files
        (->> (vulpea-db-query-by-tags-some '("project"))
             (--remove (vulpea-note-tagged-any-p it "cemetery"))
             (-map #'vulpea-note-path)
             (--remove (s-contains-p "cemetery" it :ignore-case))
             (-uniq))))
#+end_src

**CRITICAL**: This runs before every agenda view. Must be FAST!

*** Auto-Tagging System (lib-vulpea.el)
#+begin_src elisp
(defun vulpea-ensure-filetag ()
  "Automatically add tags based on:
  - Directory path
  - People notes get @Name tag
  - Notes with TODOs get 'project' tag"
  ...)

;; Runs on:
;; - before-save-hook
;; - window-buffer-change-functions
#+end_src

**CRITICAL**: Runs very frequently. Must be non-blocking!

*** Custom Attachment Tracking (lib-vulpea.el)
#+begin_src elisp
(defun vulpea-db-setup-attachments ()
  "Setup attachments table in Vulpea DB."
  (vulpea-db-define-table
   'attachments 1
   '([(node-id :not-null)
      (file :not-null)
      (hash :not-null)]
     (:foreign-key [node-id] :references nodes [id] :on-delete :cascade))
   '((attachments-node-id [node-id])))
  (add-hook 'vulpea-db-insert-note-functions
            #'vulpea-db-insert-attachments))
#+end_src

**CRITICAL**: Uses plugin system! Must be supported in v2.

*** Review System (lib-vulpea.el)
#+begin_src elisp
(defun vulpea-review-random ()
  "Visit random note sorted by 'last review' metadata."
  (seq-sort-by
   (lambda (note)
     (or (vulpea-note-meta-get note "last review")
         "[1972-01-01]"))
   #'org-time<
   (vulpea-db-query
    (lambda (note)
      (= 0 (vulpea-note-level note))))))
#+end_src

*** Batch Processing (lib-vulpea.el)
#+begin_src elisp
(vulpea-utils-process-notes notes
  ;; Migration code
  )

;; Features:
;; - Progress logging
;; - Saves after each note
;; - Kills buffers after each step (performance)
;; - Processes each note only once
#+end_src

Used for migrations and batch updates.

** Performance Requirements

| Operation | Frequency | Target | Notes |
|---|---|---|---|
| Agenda files update | Every agenda view | <200ms | Queries ~1000 project notes |
| Find candidates | Every completion | <300ms | Queries ~9000 notes |
| Auto-tagging | Every save | <50ms | Must be non-blocking |
| Review random | Manual | <500ms | Loads all file-level notes |
| Batch processing | Migrations | N/A | Can be slow, needs progress |

** Hooks Used
#+begin_src elisp
;; Before save (runs frequently!)
(add-hook 'before-save . vulpea-pre-save-hook)
  -> vulpea-ensure-filetag
  -> queries database to check if has TODOs

;; Window change (runs frequently!)
(add-hook 'window-buffer-change-functions . vulpea-setup-buffer)
  -> vulpea-ensure-filetag
  -> queries database

;; DB sync hooks
(add-hook 'org-roam-db-autosync-mode . vulpea-db-setup-attachments)
(add-hook 'org-roam-db-autosync-mode . vulpea-db-autosync-enable)
#+end_src

**CRITICAL**: Hooks that query DB must be FAST and NON-BLOCKING!

** V2 Compatibility Assessment

✅ **SUPPORTED**
- Tag-based queries (all variants)
- Generic query with predicate
- Metadata operations
- File-level vs heading-level filtering
- Note paths for agenda

⚠️ **REQUIRES ATTENTION**
- =vulpea-db-define-table= - plugin system CRITICAL
- =vulpea-db-insert-note-functions= - hook for extractors
- Performance of frequent hooks
- Batch processing utilities

❌ **REQUIRES DESIGN**
- How to handle org-roam-db references in attachment system

* Critical API Surface

** Must Preserve (High Priority)

*** Query Functions
#+begin_src elisp
(vulpea-db-query predicate)
(vulpea-db-query-by-tags-some tags)
(vulpea-db-query-by-tags-every tags)
(vulpea-db-query-by-tags-none tags)
(vulpea-db-get-by-id id)
#+end_src

*** Note Structure
#+begin_src elisp
;; Accessors used heavily:
(vulpea-note-id note)
(vulpea-note-title note)
(vulpea-note-tags note)
(vulpea-note-level note)
(vulpea-note-path note)
(vulpea-note-meta note)  ;; NEW in v1

;; Predicates:
(vulpea-note-tagged-any-p note tags)
(vulpea-note-tagged-all-p note tags)
#+end_src

*** Metadata Operations
#+begin_src elisp
(vulpea-note-meta-get note prop &optional type)
(vulpea-note-meta-get-list note prop &optional type)
(vulpea-buffer-meta-set prop value &optional append)
(vulpea-buffer-meta-sort)
#+end_src

*** Creation
#+begin_src elisp
(vulpea-create title file-name &key tags head body meta context
               properties immediate-finish unnarrowed)
#+end_src

*** Selection
#+begin_src elisp
(vulpea-select-from prompt candidates &key require-match)
(vulpea-select-multiple-from prompt candidates)
#+end_src

*** Plugin System (CRITICAL!)
#+begin_src elisp
(vulpea-db-define-table name version schema &optional indices)
(add-hook 'vulpea-db-insert-note-functions #'my-extractor)
#+end_src

** Can Modify (Low Priority)

*** Internal Functions
- =vulpea-db--*= (internal implementation)
- Query optimization (as long as results match)

*** New Features
- Better performance
- More query types
- Async operations

* Validation Against V2 Architecture

** Schema Design

*** Notes Table ✅
Includes all fields used by consumers:
- id, path, level, title ✅
- tags (JSON array) ✅
- meta (JSON object) ✅
- properties ✅
- outline-path (used by vino) ✅

*** Normalized Tables ✅
- tags table for efficient filtering ✅
- meta table for key-based queries ✅
- links table for backlinks ✅

*** Plugin System ✅ (MATCHES EXISTING API!)
#+begin_src elisp
;; V1 API (must preserve):
(vulpea-db-define-table 'attachments 1 schema indices)
(add-hook 'vulpea-db-insert-note-functions #'extractor)

;; V2 equivalent:
(vulpea-db-register-extractor
 (make-vulpea-extractor
  :name 'attachments
  :version 1
  :schema schema
  :indices indices
  :extract-fn #'extractor
  :priority 100))
#+end_src

We need a **compatibility shim** to translate old API to new!

** Query Performance ✅

Using normalized + materialized hybrid:
- =query-by-tags-some= on 10k notes: Target <50ms ✅
- =query-by-tags-every= on 1k results: Target <100ms ✅
- =get-by-id=: Target <1ms ✅

** Async Architecture ✅

File watching + batching solves:
- Non-blocking saves ✅
- Handles external changes (git) ✅
- Batch updates for performance ✅

** Metadata Type Coercion ⚠️

V1 supports type hints in metadata:
#+begin_src elisp
(vulpea-note-meta-get note "country" 'note)   ; Returns vulpea-note
(vulpea-note-meta-get note "price" 'number)   ; Returns number
(vulpea-note-meta-get note "date" 'link)      ; Returns link string
#+end_src

V2 must preserve this! Store type in meta table.

* Recommendations for V2

** 1. Preserve Plugin API ✅ CRITICAL

Add compatibility shim:
#+begin_src elisp
;; lib-vulpea-compat.el
(defun vulpea-db-define-table (name version schema &optional indices)
  "Compatibility shim for v1 plugin API."
  (vulpea-db-register-extractor
   (make-vulpea-extractor
    :name name
    :version version
    :schema schema
    :indices (or indices '())
    :extract-fn nil  ; Will be set via hook
    :priority 100)))

(defvar vulpea-db-insert-note-functions nil
  "Hook run when inserting note into database.
Each function receives the vulpea-note being inserted.")

;; Call hooks during extraction
(defun vulpea-db--run-insert-hooks (note)
  (run-hook-with-args 'vulpea-db-insert-note-functions note))
#+end_src

** 2. Preserve Metadata Type System ✅ CRITICAL

Ensure meta table has 'type' column:
#+begin_src sql
CREATE TABLE meta (
  note_id TEXT NOT NULL,
  key TEXT NOT NULL,
  value TEXT NOT NULL,
  type TEXT,  -- 'note', 'number', 'string', 'link', etc.
  FOREIGN KEY (note_id) REFERENCES notes(id) ON DELETE CASCADE
);
#+end_src

** 3. Optimize Frequent Operations ✅ CRITICAL

These run on every save/buffer-change:
- =vulpea-ensure-filetag= checks for TODOs
- Queries ~1000 project notes for agenda

Solution: Cache query results, invalidate on DB changes

** 4. Preserve Note Structure ✅

All accessors must work:
#+begin_src elisp
(cl-defstruct vulpea-note
  id path level title tags aliases properties meta links
  todo priority scheduled deadline closed outline-path attach-dir
  created-at modified-at)
#+end_src

** 5. Batch Processing Utilities ✅

Keep =vulpea-utils-process-notes= macro - critical for migrations.

** 6. Performance Targets

Update based on actual usage:

| Operation | Current | Target v2 | Scale |
|---|---|---|---|
| query-by-tags-some | ~200ms | <50ms | 10k notes |
| query-by-tags-every | ~300ms | <100ms | 10k notes |
| query-by-tags-none | ~200ms | <50ms | 10k notes |
| get-by-id | ~1ms | <1ms | Any |
| agenda-files-update | ~500ms | <200ms | 1k projects |
| generic query (all) | ~1s | <500ms | 10k notes |

* Test Cases to Add

** Vino Use Cases
#+begin_src elisp
(ert-deftest vulpea-vino-wine-entry-workflow ()
  "Test complete wine entry creation and rating workflow."
  ;; Create wine entry with metadata
  ;; Create rating linked to wine
  ;; Query by region
  ;; Verify metadata type coercion
  )

(ert-deftest vulpea-vino-geographic-filtering ()
  "Test country/region/appellation filtering."
  ;; Create geographic hierarchy
  ;; Filter by country
  ;; Verify parent links
  )
#+end_src

** Environment Use Cases
#+begin_src elisp
(ert-deftest vulpea-env-agenda-files ()
  "Test dynamic agenda file generation."
  ;; Create 1000 project notes
  ;; Call agenda-files-update
  ;; Verify performance <200ms
  ;; Verify excludes cemetery
  )

(ert-deftest vulpea-env-auto-tagging ()
  "Test automatic tag assignment."
  ;; Create note with TODO
  ;; Call ensure-filetag
  ;; Verify 'project' tag added
  )

(ert-deftest vulpea-env-attachments-plugin ()
  "Test custom attachments table."
  ;; Define attachments table
  ;; Add attachment to note
  ;; Verify in custom table
  )
#+end_src

** Performance Tests
#+begin_src elisp
(ert-deftest vulpea-perf-10k-tag-query ()
  "Benchmark tag queries at 10k scale."
  :tags '(perf)
  ;; Insert 10k notes
  ;; Query by tags-some
  ;; Verify <50ms
  )

(ert-deftest vulpea-perf-frequent-hooks ()
  "Benchmark operations called on every save."
  :tags '(perf)
  ;; Simulate vulpea-ensure-filetag
  ;; Verify <50ms
  )
#+end_src

* Summary

** Critical Features for V2

1. ✅ Tag-based queries (all variants)
2. ✅ Metadata with type coercion
3. ✅ Plugin/extractor system
4. ✅ File-level vs heading-level filtering
5. ✅ Performance for 10k+ notes
6. ✅ Non-blocking async updates

** API Compatibility

Must preserve 100% of public API:
- All =vulpea-db-query-*= functions
- All =vulpea-note-*= accessors
- All =vulpea-*-meta-*= functions
- =vulpea-create= with all options
- =vulpea-select-*= functions
- Plugin system (with compat shim)

** Performance Requirements

Based on actual usage:
- Tag queries: <50-100ms for 10k notes
- Get by ID: <1ms
- Agenda file generation: <200ms
- Auto-tagging: <50ms (non-blocking)

** Next Steps

1. Add compatibility shim to architecture plan
2. Add vino/environment test cases
3. Ensure metadata type column in schema
4. Plan query result caching strategy
