:PROPERTIES:
:ID:                     e96f8ec2-368c-4d7a-9afa-a4bab5b8511e
:END:

* Changelog
:PROPERTIES:
:ID:                     e3f3602c-426e-451e-bcb5-b59b99e3b10e
:END:

** Unreleased

*Breaking changes*

- =vulpea-db-query-attachments-by-path= now returns a list of cons cells =(DEST . ATTACH-DIR)= instead of just destination strings. This allows callers to correctly resolve attachment paths for heading-level notes that have their own attachment directories.

*Features*

- Add =vulpea-db-query-attachments-by-path= for efficiently querying all attachment link destinations for notes at a given file path. Uses a single SQL query with JOIN, avoiding N+1 queries when processing multiple notes in a file.

*Fixes*

- [[https://github.com/d12frosted/vulpea/issues/200][vulpea#200]] Fix heading-level metadata not being persisted to the database. Previously, =vulpea-db-query-by-meta-key= and =vulpea-db-query-by-meta= returned no results for heading-level metadata because =org-element-map= with NO-RECURSION ='headline= wouldn't descend into the headline element itself during extraction.
- Fix headline link extraction including links from child headlines. Previously, when extracting links for a heading-level note, all links from nested child headlines were also included. This caused issues with attachment resolution in tools like =publicatorg=, where attachments would be incorrectly resolved using parent heading's attachment directory instead of the actual heading containing the link.
- [[https://github.com/d12frosted/vulpea/issues/202][vulpea#202]] Fix link extraction to include links from non-note subtrees. Previously, links inside headings without an ID were not attributed to any note. Now links in non-note subtrees are collected as part of the nearest ancestor note, while still respecting note boundaries (headings with IDs).

** v2.0.0

*Fixes*

- =vulpea-create= now refuses to overwrite existing files. Previously, if a file existed at the target path but was not in the vulpea database, =vulpea-create= would silently overwrite it. Now it signals an error, preventing accidental data loss.

** v2.0.0-rc.2

*Breaking changes*

- [[https://github.com/d12frosted/vulpea/issues/128][vulpea#128]] =vulpea-insert= now uses keyword arguments instead of positional optional arguments. Change =(vulpea-insert filter-fn create-fn)= to =(vulpea-insert :filter-fn filter-fn :create-fn create-fn)=.

*Features*

- [[https://github.com/d12frosted/vulpea/issues/178][vulpea#178]] Add =file-title= slot to =vulpea-note= that stores the title of the file containing the note. For file-level notes, this equals the note's title. For heading-level notes, this is the parent file's title. Useful for displaying context without additional queries.
- [[https://github.com/d12frosted/vulpea/issues/178][vulpea#178]] Add =vulpea-select-describe-outline= and =vulpea-select-describe-outline-full= functions for displaying notes with their parent hierarchy in selection interfaces. Set =vulpea-select-describe-fn= to use them.
- [[https://github.com/d12frosted/vulpea/issues/128][vulpea#128]] Add =:candidates-fn= argument to =vulpea-insert=, aligning with =vulpea-find=. Allows customizing the source of candidates for note selection during insert.
- [[https://github.com/d12frosted/vulpea/issues/75][vulpea#75]] Add heading-level metadata support to =vulpea-meta-*= and =vulpea-buffer-meta-*= functions. Metadata operations now scope to the correct level based on the note: file-level notes access metadata before any headings, while heading-level notes access metadata within their subtree. This ensures consistent behavior between database extraction (which already supported heading-level meta) and the API.

*Performance*

- [[https://github.com/d12frosted/vulpea/issues/129][vulpea#129]] Optimize =vulpea-db-query-by-tags-every=, =vulpea-db-query-by-tags-none=, and =vulpea-db-query-by-links-every= to use single SQL queries with subqueries instead of two separate queries. Provides ~1.3-1.4x speedup for large result sets.
- [[https://github.com/d12frosted/vulpea/issues/66][vulpea#66]] Add =vulpea-meta-set-batch= and =vulpea-buffer-meta-set-batch= for setting multiple metadata properties efficiently. Parses the buffer only once instead of N times, providing significant speedup (2-10x depending on property count).

*Fixes*

- Interactive meta commands (=vulpea-meta-add=, =vulpea-meta-add-list=, =vulpea-meta-remove=, =vulpea-meta-clean=) now correctly operate on the note at point, including heading-level notes.

** v2.0.0-rc.1
:PROPERTIES:
:ID:                     32a267f4-dd27-44b9-a045-5835a5c8503f
:END:

This is a complete rewrite of Vulpea that removes the dependency on =org-roam=. Vulpea now manages its own database and provides all functionality independently.

*Breaking changes*

- =org-roam= is no longer required. Vulpea manages its own SQLite database.
- Database location changed from org-roam's db to =vulpea-db-file= (default: =vulpea.db= in =vulpea-directory=).
- =vulpea-db-update= renamed to =vulpea-db-update-file=.

*New Sync System*

Vulpea now has its own file synchronization system (=vulpea-db-sync.el=):
- Multiple backends: =filenotify= (default), =fswatch= (for large directories), =polling= (fallback).
- Async batched updates to avoid blocking Emacs.
- Configurable via =vulpea-db-sync-backend=, =vulpea-db-sync-directories=.
- Start with =vulpea-db-sync-start=, stop with =vulpea-db-sync-stop=.

*vulpea-note changes*

- Links now include =:pos= (buffer position) in addition to =:source= and =:dest=.
- All link types are captured: =id=, =https=, =file=, =attachment=, etc.
- New slot =:attach-dir= for attachment directory path.

*New Query Functions*

- =vulpea-db-query-by-directory= - query notes by directory path.
- =vulpea-db-query-by-file-path= - query notes by exact file path.
- =vulpea-db-search-by-title= - search notes by title substring.
- =vulpea-db-query-by-created-date= - query notes by creation date (from =CREATED= property).
- =vulpea-db-query-by-property= - query notes by property key and value.
- =vulpea-db-query-by-property-key= - query notes that have a specific property.

*Fixes*

- Fix inconsistency where directory scans (=vulpea-db-sync-update-directory=, =vulpea-db-sync-full-scan=, initial scan, and polling) would index files in hidden directories (paths containing =/.*=), while file watchers excluded them. Now all sync methods consistently exclude hidden directories.
- Fix fswatch filter incorrectly processing partial paths when output is split across buffer boundaries, which could cause scanning of directories outside the watched paths.

*Features*

- Exclude archived entries from the database by default. Controlled by =vulpea-db-exclude-archived= (default =t=). Entries are considered archived if they have the =org-archive-tag= (directly or inherited) or the =ARCHIVE_TIME= property.
- Populate =created-at= column from =CREATED= property during extraction. Enables efficient querying of notes by creation date via =vulpea-db-query-by-created-date=.
- Add normalized =properties= table for efficient property-based queries. Properties are now stored both in the JSON blob (for full note retrieval) and in a normalized table (for indexed queries via =vulpea-db-query-by-property= and =vulpea-db-query-by-property-key=).
- Add =vulpea-note-expand-aliases= utility function that expands a note into multiple notes based on aliases. Returns a list where the first element has the original title and subsequent elements have each alias as title with =primary-title= set to the original. Useful for selection interfaces.
- Add =:expand-aliases= parameter to =vulpea-select=, =vulpea-select-from=, and =vulpea-select-multiple-from=. When non-nil, notes with aliases appear multiple times in completion - once for the original title and once for each alias. Selected alias notes have the alias as =title= and original as =primary-title=.

** v0.4.0

Last release based on =org-roam=. Future versions (v2) will be independent of =org-roam=.

*Features*

- Include attachment directory in =vulpea-note= and =notes= table.
- [[https://github.com/d12frosted/vulpea/issues/130][vulpea#130]] Introduce mechanism to automatically rebuild database when needed. This happens either on the first usage of Vulpea or when =vulpea-db-version= increases.
- [[https://github.com/d12frosted/vulpea/pull/158][vulpea#158]] Introduce mechanism to define more tables in Org Roam database (see =vulpea-db-define-table=). And provide a hook to fill defined tables with data (see =vulpea-db-insert-note-functions=).
- Handle forced database sync. Whenever it happens, make sure that all the extra tables are initialized and versions are set accordingly.
- Respect aliases used in the meta blocks when extracting value as a note.
- Introduce =vulpea-insert-default-candidates-source=.
- Introduce =vulpea-db-query-by-tags-none=.
- Include =outline-path= in =vulpea-note= and bump =notes= table version (i.e. a full rebuild is required).
- Introduce =vulpea-db-query-by-level=, which returns all notes of a given =LEVEL=.
- Improve performance of =vulpea-meta-get-list= and =vulpea-note-meta-get-list= for notes by using single call to db.
- Allow to pass meta when creating a new note.
- Allow to control how new note is created when a non-existent one is picked in the insert flow.
- Allow to pass Org capture properties when creating a new note.
- Introduce shortcuts for checking of a note links to all/any of the given links.
- Allow to override description in =vulpea-utils-link-make-string=.
- Function to sort metadata in a buffer.
- =vulpea-select-multiple-from= function.

** v0.3.0
:PROPERTIES:
:ID:                     40e2d01c-9100-4619-b771-c3df79d98f36
:END:

This release's main feature is a dedicated view table to boost the performance of query operations. In addition, it provides some specialized queries for situations when the set of notes can be narrowed down by tags or links.

In addition, =vulpea-note= now has properties, meta and links as part of its structure.

*Features*

- [[https://github.com/d12frosted/vulpea/issues/97][vulpea#97]] Expose properties in =vulpea-note=.
- [[https://github.com/d12frosted/vulpea/issues/100][vulpea#100]] Persist note meta in =org-roam-db=.
- [[https://github.com/d12frosted/vulpea/issues/100][vulpea#100]] Provide an API to access/extract data from =vulpea-note-meta=:
  - =vulpea-note-meta-get-list= - to get all values of given =PROP= and =TYPE=.
  - =vulpea-note-meta-get= - to get the first value of given =PROP= and =TYPE=.
- New function to remove buffer properties - =vulpea-buffer-prop-remove=.
- Improve =filetags= handling:
  - Property format them with =:= as separator;
  - Remove property when setting them to empty list instead of leaving empty property.
- New function to select on arbitrary list of notes as opposed to relying on filter - =vulpea-select-from=.
- [[https://github.com/d12frosted/vulpea/discussions/106][vulpea#106]] Include links in =vulpea-note=.
- [[https://github.com/d12frosted/vulpea/discussions/106][vulpea#106]] Provide more functions to query notes in efficient manner:
  - =vulpea-db-query-by-tags-some= - return all notes tagged with one of the provided =TAGS=;
  - =vulpea-db-query-by-tags-every= - return all notes tagged by every tag from the list of provided =TAGS=;
  - =vulpea-db-query-by-links-some= - return all notes linking at least one of the provided =DESTINATIONS=;
  - =vulpea-db-query-by-links-every= - return all notes linking each and every provided =DESTINATIONS=;
- [[https://github.com/d12frosted/vulpea/pull/116][vulpea#116]] improve query performance by building and maintaining a separate view table.
- [[https://github.com/d12frosted/vulpea/issues/121][vulpea#121]] allow to configure candidates source for =vulpea-find= function via =vulpea-find-default-candidates-source= variable.
- Add shortcuts for checking tags on the note:
  - =vulpea-note-tagged-all-p= - return non-nil if a NOTE is tagged by all of the TAGS.
  - =vulpea-note-tagged-any-p= - return non-nil if a NOTE is tagged by any of the TAGS.

** v0.2.0
:PROPERTIES:
:ID:                     d7dd89d9-40aa-4e7c-933e-61bb5cd3e953
:END:

Primarily migration to =org-roam= v2 that has many improvements and breaking changes.

*Features*

- Allow to provide extra properties in =vulpea-create=.
- New function to manipulate =#+title=: =vulpea-buffer-title-set= and =vulpea-buffer-title-get=.
- New functions to manipulate =#+filetags=:
  - =vulpea-buffer-tags-get= - function to get list of tags.
  - =vulpea-buffer-tags-set= - function to set/replace the value of =#+filetags=.
  - =vulpea-buffer-tags-add= - function to add a tag to =#+filetags=.
  - =vulpea-buffer-tags-remove= - function to remove a tag from =#+filetags=.
- New functions to manipulate buffer-wide properties in the buffer header using =#+NAME: value= format:
  - =vulpea-buffer-prop-set= - function to set a =VALUE= of property with =NAME= in the current buffer.
  - =vulpea-buffer-prop-set-list= - function to set a value of property with =NAME= to the list of =VALUES= in the current buffer.
  - =vulpea-buffer-prop-get= - function to get a value of property with =NAME= from the current buffer.
  - =vulpea-buffer-prop-get-list= - function to get a value of property with =NAME= as a list separated by some =SEPARATORS=.
- Extract buffer related functions (prop and meta related) to separate module. Basically, this means that now it's possible to manipulate meta lists that are located in any org file, not necessarily part of =vulpea=.
- Add =aliases= and =primary-title= slots to =vulpea-note=.
- Use custom completion in =vulpea-select= instead of one provided by =org-roam=. See documentation for more information.
- New functionality to select and find a note:
  - =vulpea-find= - just a wrapper around =vulpea-select= to provide a consistent experience; selection can be narrowed down by =vulpea-find-default-filter= or by passing explicit filter.
  - =vulpea-find-backlink= - select and find a backlink to current note.
- New functionality to insert a link to the note via =vulpea-insert=, which accepts global and local filter (just like =vulpea-find=) and allows to hook into finalisation (e.g. call your custom handler after the link was inserted regardless involvement of capture process). See documentation for more information.
- New utilities to repeat functions:
  - =vulpea-utils-collect-while=;
  - =vulpea-utils-repeat-while=.
- [[https://github.com/d12frosted/vulpea/issues/98][vulpea#98]] Make it possible to use =vulpea-meta-remove= interactively.
- [[https://github.com/d12frosted/vulpea/issues/98][vulpea#98]] Make it possible to use =vulpea-meta-clean= interactively.
- [[https://github.com/d12frosted/vulpea/issues/98][vulpea#98]] Provide interactive variant of =vulpea-meta-set=: =vulpea-meta-add= and =vulpea-meta-add-list=.
- All features of =org-roam= apply to =vulpea=.

*Breaking changes*

- Flatten template in =vulpea-create=, meaning that instead of passing a template in format =(:body :file-name :head :unnarrowed :immediate-finish)=, all values should be passed as arguments to =vulpea-create=. Also, there is no need to provide =#+title: ${title}= in =:head= anymore. See =vulpea-create= documentation for more information.
  #+begin_src emacs-lisp
    ;; instead of
    (vulpea-create title
                   (list :file-name file-name
                         :head "#+title: ${title}\n#+url: ${url}\n#+filetags: tag1 tag2\n"
                         :unnarrowed t
                         :immediate-finish t)
                   (list (cons url "https://example.org")
                         (cons id "xyz")))

    ;; you should
    (vulpea-create title
                   file-name
                   :id xyz
                   :tags '("tag1" "tag2")
                   :head "#+url: ${url}"
                   :unnarrowed t
                   :immediate-finish t
                   :context
                   (list :url "https://example.org"))
  #+end_src
- Remove =vulpea-setup= because =org-roam= v2 already provides all information to get resulting file of capture process.
- Remove =vulpea-note-meta=. It was only used for =vulpea-select=, but now it is not needed anymore.
- All breaking changes of =org-roam= apply to =vulpea=.

** v0.1.1
:PROPERTIES:
:ID:                     a5682f43-7d2e-47ea-9889-db1ecceb42ef
:END:

Primarily a stabilization and bug-fix release.

*Features*

- [[https://github.com/d12frosted/vulpea/pull/84][vulpea#84]] Support passing extra context for templates to =vulpea-create=. This is a /breaking change/, now instead of passing =id= argument, you should pass =(list (cons 'id id))=. While being more verbose it gives much more power.
- [[https://github.com/d12frosted/vulpea/pull/85][vulpea#85]] Support require match in =vulpea-select=. This is a /breaking change/, as arguments to =vulpea-select= are passed as keys. In my experience, most of the times first two arguments are =nil= and they are rarely needed. In this way, API of this function is cleaner and opens a way to add new functionality there.
- [[https://github.com/d12frosted/vulpea/pull/86][vulpea#86]] New function =vulpea-db-query= to query notes with generic predicate.
- [[https://github.com/d12frosted/vulpea/pull/86][vulpea#86]] Add metadata to =vulpea-note= consisting of access time and modification time.
- [[https://github.com/d12frosted/vulpea/pull/86][vulpea#86]] Use =vulpea-db-query= in =vulpea-select= instead of heavy =org-roam-db-query=.
- [[https://github.com/d12frosted/vulpea/pull/89][vulpea#89]] =vulpea-utils-note-hash= function to calculate =sha1= of a given =NOTE=.
- [[https://github.com/d12frosted/vulpea/issues/90][vulpea#90]] =vulpea-create= automatically adds a property block with id into created file (formatted according to =org-property-format=). This also breaks API, see breaking changes section for more information.

*Fixes*

- [[https://github.com/d12frosted/vulpea/pull/80][vulpea#80]] Fix how =org-roam-capture--new-file= is called from advice.

*Breaking changes*

- [[https://github.com/d12frosted/vulpea/pull/82][vulpea#82]] Remove all autoloads.
- [[https://github.com/d12frosted/vulpea/pull/86][vulpea#86]] =vulpea-select= does not allow to pass =completions= anymore.
- [[https://github.com/d12frosted/vulpea/pull/87][vulpea#87]] =org-roam-capture--new-file= is not being adviced by default anymore. Instead you should call =vulpea-setup=.
- [[https://github.com/d12frosted/vulpea/issues/90][vulpea#90]] =vulpea-create= does not accept =org-roam-template= (whatever that means), instead it accepts a structured property list =(:file-name :head :unnarrowed :immediate-finish)= which is converted into something supported by =org-roam=. Migration is simple - just remove irrelevant parts.

** v0.1
:PROPERTIES:
:ID:                     2649dad1-485a-4082-986a-5d67698604db
:END:

*Features*

- =vulpea= module - one stop module, importing all others.
  - =vulpea-select= - function to =completing-read= a note with optional filter.
  - =vulpea-create= - function to create a new note file with given =TITLE= and =TEMPLATE=.
- =vulpea-db= module - for querying notes data base.
  - =vulpea-db-get-id-by-file= - function to get =ID= of a note represented by =FILE=.
  - =vulpea-db-get-by-id= - function to get note represented by =ID=. Supports headings of the note.
  - =vulpea-db-get-file-by-id= - function to get =FILE= of a note represented by =ID=. Supports headings of the note.
  - =vulpea-db-search-by-title= - function to query notes with =TITLE=.
  - =vulpea-db-update= - function to update db with =NOTE-OR-ID=.
- =vulpea-meta= module - for manipulating note metadata represented by description list:
  - =vulpea-meta= - function to get metadata from =NOTE-OR-ID=. In most cases you should not use this function unless performance is important. In this case, take a look at bang functions, e.g. =vulpea-meta-get!=.
  - =vulpea-meta-get= - function to get a value of =PROP= for note with =ID=. Value is parsed based on the passed =TYPE= or as a string if omitted.
  - =vulpea-meta-get!= - function to get a value of =PROP= from =META= (result of =vulpea-meta=). Value is parsed based on the passed =TYPE= or as a string if omitted. Use it performing multiple read operations in a row.
  - =vulpea-meta-get-list= - function to get all values of =PROP= for note with =ID=. Values are parsed based on the passed =TYPE= or as a string if omitted.
  - =vulpea-meta-get-list!= - function to get all values of =PROP= from =META= (result of =vulpea-meta=). Values are parsed based on the passed =TYPE= or as a string if omitted. Use it performing multiple read operations in a row.
  - =vulpea-meta-set= - function to set =VALUE= of =PROP= for =NOTE-OR-ID=. Supports multi-value properties.
  - =vulpea-meta-remove= - function to remove a =PROP= for =NOTE-OR-ID=.
  - =vulpea-meta-remove= - function to remove all meta for =NOTE-OR-ID=.
  - =vulpea-meta-format= - function to format a =VALUE=.
- =vulpea-utils= module.
  - =vulpea-note= type definition.
  - =vulpea-utils-with-note= - function to execute =BODY= with point at =NOTE=. Supports file-level notes as well as heading notes.
  - =vulpea-utils-link-make-string= - make a bracket link to =NOTE=.
