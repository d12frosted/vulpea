#+OPTIONS: toc:nil

* Vulpea

#+begin_html
<p align="center">
  <img width="256px" src="./images/logo.png" alt="Banner">
</p>
<p align="center">
  <a href="https://github.com/d12frosted/vulpea/tree/v2-rewrite"><img alt="v2-rewrite branch" src="https://img.shields.io/badge/branch-v2--rewrite-blue"/></a>
  <a href="https://github.com/d12frosted/vulpea/actions"><img alt="Tests" src="https://img.shields.io/badge/tests-passing-green"/></a>
</p>
#+end_html

A high-performance, async-first note-taking library for Emacs. Vulpea provides a powerful database layer for org-mode notes with support for metadata, tags, links, and custom extractors. Designed to scale to 100k+ notes without blocking your workflow.

*Version 2.0* is a complete rewrite with no org-roam dependency, featuring async file watching, smart change detection, and a plugin system for extensibility.

** Installation

*Note:* v2 is currently on the =v2-rewrite= branch and not yet released to package archives.

*** From Source (Development)

#+begin_src bash
git clone https://github.com/d12frosted/vulpea
cd vulpea
git checkout v2-rewrite
#+end_src

Add to your Emacs configuration:

#+begin_src emacs-lisp
(add-to-list 'load-path "/path/to/vulpea")
(require 'vulpea)
#+end_src

*** Dependencies

- Emacs 27.2+
- =org-mode= 9.4.4+
- =emacsql= 4.3.0+ (with =emacsql-sqlite-builtin=)
- =s= 1.12+
- =dash= 2.19+

*** Optional Dependencies (Recommended)

#+ATTR_ORG: :align lll :width 100
| Tool    | Purpose                            | Install Command (macOS / Debian / Arch)                        |
|---------+------------------------------------+----------------------------------------------------------------|
| =fd=      | 15√ó faster directory scanning      | =brew install fd= / =apt install fd-find= / =pacman -S fd=           |
| =fswatch= | Reliable external change detection | =brew install fswatch= / =apt install fswatch= / =pacman -S fswatch= |

Without these tools, Vulpea falls back to slower but functional alternatives (=find= and polling).

** Quick Start

You‚Äôre ready when:
1. Directories are configured and the database is primed.
2. Autosync runs (or manual sync is done) and notes have IDs.
3. You can query notes through =vulpea-db-*= functions or =M-x vulpea-find=.

*** 1. Configure Directories

#+begin_src emacs-lisp
(require 'vulpea)

;; Set your notes directory
(setq vulpea-db-sync-directories '("~/org/"))

;; Optional: configure database location
(setq vulpea-db-location
      (expand-file-name "vulpea.db" user-emacs-directory))
#+end_src

*** 2. Prime the Database

Vulpea needs an initial pass over every note. Pick one of these options:

#+begin_src emacs-lisp
;; Option A (recommended): run an explicit full sync once
(vulpea-db-sync-full-scan)

;; Option B: scan automatically when autosync starts (blocking)
(setq vulpea-db-sync-scan-on-enable 'blocking)
#+end_src

Option A makes the initial sync explicit and works regardless of how you
toggle autosync. Option B lets =vulpea-db-autosync-mode= perform the
first scan (you can use ='async= if you prefer to queue work in the
background).

Whichever path you choose, expect the first scan to parse every file
(plan for a few minutes on 100k+ notes). Re-run
=vulpea-db-sync-full-scan= (or set =vulpea-db-sync-scan-on-enable= temporarily)
whenever you change global settings and need to rebuild everything.

*** 3. Enable Auto-Sync

#+begin_src emacs-lisp
;; Enable automatic file watching and database updates
(vulpea-db-autosync-mode +1)
#+end_src

This starts monitoring your notes directory for changes and keeps the database up-to-date automatically.
If you relied on Option A above (manual full sync), you can keep
=vulpea-db-sync-scan-on-enable= at =nil= for faster startups; autosync
will now process only incremental edits.

*** 4. Ensure Notes Have IDs

Vulpea only indexes notes with =ID= properties. Add an ID to the beginning of your org files:

#+begin_src org
:PROPERTIES:
:ID: 5093fc4e-8c63-4e60-a1da-83fc7ecd5db7
:END:
#+title: My Note

Content here...
#+end_src

Use =M-x org-id-get-create= to add IDs interactively.

*** 5. Query Your Notes (or try `M-x vulpea-find`)

#+begin_src emacs-lisp
;; Find notes with specific tags
(vulpea-db-query-by-tags-some '("project" "active"))

;; Get a note by ID
(vulpea-db-get-by-id "note-id-here")

;; Search by title
(vulpea-db-search-by-title "Meeting")
#+end_src

** Configuration Essentials

Review these settings before relying on autosync‚Äîpicking the right trade-offs here
determines Vulpea's performance and correctness.

*** Database & Directories

#+begin_src emacs-lisp
;; Database file location
(setq vulpea-db-location
      (expand-file-name "vulpea.db" user-emacs-directory))

;; Directories to watch and sync
(setq vulpea-db-sync-directories
      '("~/org/" "~/notes/"))

;; Default directory for new notes (MUST be inside one of the sync dirs)
(setq vulpea-default-notes-directory "~/org/")
#+end_src

*** Parsing Method

Choose how Vulpea loads Org files:

#+begin_src emacs-lisp
;; Single temp buffer: absolute fastest, skips org-mode hooks entirely.
;; Only use when your configuration is purely global.
(setq vulpea-db-parse-method 'single-temp-buffer)

;; Temp buffer (default): reuses a buffer but re-runs org-mode per file.
;; Honors #+TODO, #+PROPERTY, org-mode-hook, etc.
(setq vulpea-db-parse-method 'temp-buffer)

;; Find file: visits files like =find-file=, respects dir-locals,
;; and all file-visiting hooks. Slowest but most accurate.
(setq vulpea-db-parse-method 'find-file)
#+end_src

- =single-temp-buffer=: ‚ö° ~1k files/sec. Skips org-mode hooks and per-file keywords.
- =temp-buffer=: ‚úì Honors org-mode hooks per file. ~460/sec, degrades to ~56/sec at scale.
- =find-file=: ‚úì Respects dir-locals/file-visiting hooks. ~34/sec, degrades to ~16/sec at scale.

If an =org-mode-hook= is expensive (e.g. =org-roam=), wrap it in
=(unless (bound-and-true-p 'vulpea-db--active-parse-method) ‚Ä¶)= so it is
skipped when Vulpea parses notes. See [[file:bench/PERFORMANCE.md][bench/PERFORMANCE.md]] for detailed benchmarks.

*** Indexing Control

#+begin_src emacs-lisp
;; Disable heading-level indexing (2-3x faster)
(setq vulpea-db-index-heading-level nil)

;; Selective indexing with predicate
(setq vulpea-db-index-heading-level
      (lambda (path)
        (string-match-p "/daily/" path)))

;; Enable for all files (default)
(setq vulpea-db-index-heading-level t)
#+end_src

*** Sync Performance Knobs

#+begin_src emacs-lisp
;; Debounce delay before processing changes (seconds)
(setq vulpea-db-sync-batch-delay 2.0)

;; Maximum files per batch
(setq vulpea-db-sync-batch-size 100)

;; Idle timer delay (seconds)
(setq vulpea-db-sync-idle-delay 0.5)

;; Progress reporting interval (nil to disable)
(setq vulpea-db-sync-progress-interval 500)
#+end_src

*** External Change Detection

#+begin_src emacs-lisp
;; Auto: try fswatch, fallback to polling (recommended)
(setq vulpea-db-sync-external-method 'auto)

;; FSWatch: requires 'fswatch' binary (most reliable)
(setq vulpea-db-sync-external-method 'fswatch)

;; Polling: pure Elisp, no dependencies
(setq vulpea-db-sync-external-method 'poll)
(setq vulpea-db-sync-poll-interval 2)  ; check every 2 seconds

;; Filenotify only: unreliable for external changes
(setq vulpea-db-sync-external-method nil)
#+end_src

Install =fswatch= for the most reliable external change detection (see Dependencies section).

*** Startup Behavior

#+begin_src emacs-lisp
;; Control initial scan when enabling autosync-mode
;; nil: skip scan (fast startup, recommended)
(setq vulpea-db-sync-scan-on-enable nil)

;; 'async: queue files for async processing (non-blocking scan)
(setq vulpea-db-sync-scan-on-enable 'async)

;; 'blocking: scan and update synchronously (blocks until complete)
(setq vulpea-db-sync-scan-on-enable 'blocking)
#+end_src

*** Default Note Templates

Configure default parameters for note creation to avoid repeating the same settings:

#+begin_src emacs-lisp
;; Static template (simple configuration)
(setq vulpea-create-default-template
      '(:file-name "${timestamp}_${slug}.org"
        :tags ("inbox" "fleeting")
        :head "#+created: %<[%Y-%m-%d]>\n#+source: %(buffer-name)"
        :properties (("CREATED" . "%<[%Y-%m-%d]>")
                     ("AUTHOR" . "%(user-full-name)"))))

;; Dynamic function (context-aware defaults)
(setq vulpea-create-default-function
      (lambda (title)
        (list :file-name (format "%s_%s.org"
                                 (format-time-string "%Y%m%d%H%M%S")
                                 (vulpea-title-to-slug title))
              :tags (if (string-match-p "TODO" title)
                        '("task" "inbox")
                      '("fleeting"))
              :head (format "#+created: %s"
                            (format-time-string "[%Y-%m-%d]"))
              :context (list :source (buffer-name)))))

;; Default directory for new notes (should be part of sync dirs)
(setq vulpea-default-notes-directory "~/org/")
#+end_src

These defaults apply to all note creation flows (=vulpea-create=, =vulpea-find=, =vulpea-insert=).
Explicitly passed parameters always override defaults.

Template expansion in defaults supports:
- =${var}= - Variable substitution (title, slug, timestamp, id, custom)
- =%(elisp)= - Elisp evaluation (e.g., =%(user-full-name)=)
- =%<format>= - Timestamp formatting (e.g., =%<[%Y-%m-%d]>=)

Available template parameters:
- =:file-name= - File name template (relative to default directory)
                 Can also be a function: =(lambda (title) ...)=
- =:tags= - List of tag strings
- =:head= - Header content after #+filetags
- =:body= - Note body content
- =:properties= - Alist of (key . value) for property drawer
- =:meta= - Alist of (key . value) for metadata
- =:context= - Plist of custom template variables

If =vulpea-default-notes-directory= points outside
=vulpea-db-sync-directories=, new notes won't be indexed until you add the
missing directory to =vulpea-db-sync-directories= and run a full sync

** Key Features

*** üöÄ Async-First Architecture
- Non-blocking database updates
- File watchers detect changes from Emacs, git, Dropbox, etc.
- Smart batching: 100 file changes = 1 transaction
- Dual-mode: async for interactive use, sync for programmatic operations

*** üìä Optimized Database
- Hybrid schema: materialized + normalized tables for optimal read performance
- Hash-based change detection skips parsing unchanged files
- Configurable heading-level indexing (disable for 2-3x speedup)
- Foreign key cascades for automatic cleanup

*** üîå Extensible Plugin System
- Parse-once architecture: single org-element parse shared across all extractors
- Custom database tables with schema versioning
- Priority-based execution order
- Example plugins included
- See [[file:docs/plugin-guide.org][Plugin Guide]] for details

*** üè∑Ô∏è Rich Metadata Support
- Type-aware metadata with read-time coercion: =note=, =number=, =string=, =link=, =symbol=
- Tag-based queries with indexed lookups
- Link tracking for all org-mode link types (id:, file:, http:, attachment:, etc.)
- Full-text title search

*** ‚ö° Performance at Scale
- Designed for 100k+ notes
- Read-optimized queries
- Idle timer processing
- Configurable debouncing and batch sizes

** Usage Guide

*** Working with Notes

**** Finding Notes

#+begin_src emacs-lisp
;; Interactive note selection with completion
(vulpea-find)

;; Find notes linking to current note
(vulpea-find-backlink)

;; Insert a link to a note
(vulpea-insert)
#+end_src

**** Creating Notes

#+begin_src emacs-lisp
;; Create a new note programmatically
(vulpea-create "My New Note")

;; With explicit parameters (override defaults)
(vulpea-create "Project Note"
               nil  ; file-name (nil = use template)
               :tags '("project" "work")
               :properties '(("STATUS" . "active")))

;; With template expansion
(vulpea-create "Meeting Notes"
               nil
               :head "#+date: %<[%Y-%m-%d]>\n#+attendees: %(user-full-name)"
               :body "## Agenda\n\n## Notes\n\n"
               :context '(:project "MyProject"))

;; With metadata
(vulpea-create "Wine Review"
               nil
               :meta '(("country" . "France")
                       ("rating" . "95")))
#+end_src

Note: If you've configured =vulpea-create-default-template= or
=vulpea-create-default-function=, those defaults will be applied automatically.
Explicit parameters always override defaults.

**** Visiting Notes

#+begin_src emacs-lisp
;; Visit a note by ID or note object
(vulpea-visit "note-id-123")

;; Visit in other window
(vulpea-visit note-object t)
#+end_src

*** Querying the Database

**** By Tags

#+begin_src emacs-lisp
;; Notes with ANY of these tags
(vulpea-db-query-by-tags-some '("wine" "red"))

;; Notes with ALL of these tags
(vulpea-db-query-by-tags-every '("project" "active"))

;; Notes WITHOUT these tags
(vulpea-db-query-by-tags-none '("archive" "deprecated"))
#+end_src

**** By Links

#+begin_src emacs-lisp
;; Notes linking to a specific ID
(vulpea-db-query-by-links-some '("note-id-123"))

;; Filter by link type
(vulpea-db-query-by-links-some '("note-id-123") "id")

;; Notes linking to ALL of these IDs
(vulpea-db-query-by-links-every '("id-1" "id-2"))
#+end_src

**** By Metadata

#+begin_src emacs-lisp
;; Notes with a specific metadata key
(vulpea-db-query-by-meta-key "country")

;; Notes where key equals value
(vulpea-db-query-by-meta "country" "France")

;; With type coercion (for note references)
(vulpea-db-query-by-meta "region" "region-id-123" "note")
#+end_src

**** By Level

#+begin_src emacs-lisp
;; File-level notes only (level 0)
(vulpea-db-query-by-level 0)

;; Heading-level notes (level > 0)
(vulpea-db-query-by-level 1)
#+end_src

**** Custom Queries

#+begin_src emacs-lisp
;; Query with custom predicate
(vulpea-db-query
 (lambda (note)
   (and (member "project" (vulpea-note-tags note))
        (string-prefix-p "2025" (vulpea-note-title note)))))
#+end_src

**** Statistics

#+begin_src emacs-lisp
(vulpea-db-count-notes)                    ; Total notes
(vulpea-db-count-file-level-notes)         ; File-level only
(vulpea-db-count-heading-level-notes)      ; Heading-level only
#+end_src

*** Working with Metadata

**** Defining Metadata

In your org file, use property drawer or metadata format:

#+begin_src org
:PROPERTIES:
:ID: wine-id-123
:END:
#+title: Ch√¢teau Margaux 2015

- country :: France
- price :: 45.99
- region :: [[id:burgundy-id-456][Burgundy]]
- url :: https://example.com
#+end_src

Type information is inferred at read-time based on the type parameter you pass to
=vulpea-note-meta-get=, not stored in the database.

**** Reading Metadata

Vulpea provides two functions for reading metadata from notes:

- =vulpea-note-meta-get= - Get the first value of a metadata property
- =vulpea-note-meta-get-list= - Get all values when a property has multiple entries

Both functions support automatic type coercion:

- =string= (default) - Plain text value
- =number= - Converts string to number
- =symbol= - Interns string as symbol
- =link= - Extracts ID from =id:= links or returns raw link
- =note= - Resolves =id:= link to =vulpea-note= struct

***** Single Values

#+begin_src emacs-lisp
(let ((note (vulpea-db-get-by-id "wine-id-123")))
  ;; Get first value with type coercion
  (vulpea-note-meta-get note "country")              ; "France"
  (vulpea-note-meta-get note "price" 'number)        ; 45.99 (number)
  (vulpea-note-meta-get note "region" 'note)         ; <vulpea-note object>
  (vulpea-note-meta-get note "url" 'link))           ; "https://example.com"
#+end_src

***** Multiple Values

When a metadata property has multiple values, use =vulpea-note-meta-get-list=:

#+begin_src emacs-lisp
;; Example note with multiple grape varieties:
;; - grapes :: [[id:grape1][Cabernet Sauvignon]]
;; - grapes :: [[id:grape2][Merlot]]
;; - grapes :: [[id:grape3][Syrah]]

(let ((note (vulpea-db-get-by-id "wine-id-123")))
  ;; Get all grape varieties as notes
  (vulpea-note-meta-get-list note "grapes" 'note)
  ;; => (#s(vulpea-note :id "grape1" :title "Cabernet Sauvignon" ...)
  ;;     #s(vulpea-note :id "grape2" :title "Merlot" ...)
  ;;     #s(vulpea-note :id "grape3" :title "Syrah" ...))

  ;; Get all ratings as numbers
  (vulpea-note-meta-get-list note "ratings" 'number))
  ;; => (95 92 88)
#+end_src

**** Setting Metadata

#+begin_src emacs-lisp
;; In a note buffer
(vulpea-buffer-meta-set "status" "active" 'string)
(vulpea-buffer-meta-set "rating" "95" 'number)
(vulpea-buffer-meta-set "producer" "producer-id" 'note)
#+end_src

**** Managing Aliases

Vulpea provides functions to manage note aliases. Aliases are stored in a property
defined by =vulpea-buffer-alias-property= (defaults to =ALIASES=):

#+begin_src emacs-lisp
;; Optional: customize the property name for org-roam compatibility
(setq vulpea-buffer-alias-property "ROAM_ALIASES")

;; Get current aliases
(vulpea-buffer-alias-get)
;; => ("Short Name" "Alternative Title")

;; Add a new alias
(vulpea-buffer-alias-add "New Alias")

;; Add an alias with spaces (automatically quoted)
(vulpea-buffer-alias-add "Alias With Spaces")

;; Remove an alias (with interactive completion)
(vulpea-buffer-alias-remove "Short Name")

;; Remove an alias programmatically
(vulpea-buffer-alias-remove "Alternative Title")
#+end_src

Key features:
- Configurable property name via =vulpea-buffer-alias-property=
- Automatic quoting of aliases containing spaces
- Duplicate detection (adding an existing alias is ignored)
- Interactive completion when removing aliases
- Automatically removes property when last alias is removed
- Properly parses mixed quoted and unquoted aliases

*** Synchronization

**** Manual Sync

#+begin_src emacs-lisp
;; Update a single file
(vulpea-db-sync-update-file "/path/to/note.org")

;; Update entire directory
(vulpea-db-sync-update-directory "~/org/")

;; Full scan of all configured directories (smart detection)
(vulpea-db-sync-full-scan)

;; Force re-index (e.g., after changing configuration)
;; Interactive: M-x vulpea-db-sync-full-scan with C-u prefix
(vulpea-db-sync-full-scan 'force)
#+end_src

**** Programmatic Batch Operations

For creating many notes programmatically, use synchronous mode:

#+begin_src emacs-lisp
(vulpea-with-sync-db
  (dotimes (i 100)
    (vulpea-create (format "Note %d" i)
                   :tags '("generated")
                   :immediate-finish t)))
;; All updates complete before proceeding
#+end_src

** API Quick Reference

*** Core Functions

| Function             | Description                               |
|----------------------+-------------------------------------------|
| =vulpea-find=          | Interactive note selection and navigation |
| =vulpea-find-backlink= | Find notes linking to current note        |
| =vulpea-insert=        | Insert link to a note (with completion)   |
| =vulpea-create=        | Create a new note programmatically        |
| =vulpea-visit=         | Visit a note by ID or note object         |

*** Query Functions

| Function                       | Description                             |
|--------------------------------+-----------------------------------------|
| =vulpea-db-query=                | Query all notes with optional predicate |
| =vulpea-db-get-by-id=            | Get single note by ID (fastest)         |
| =vulpea-db-search-by-title=      | Search notes by title substring         |
| =vulpea-db-query-by-tags-some=   | Notes with ANY of the given tags        |
| =vulpea-db-query-by-tags-every=  | Notes with ALL of the given tags        |
| =vulpea-db-query-by-tags-none=   | Notes WITHOUT any of the given tags     |
| =vulpea-db-query-by-links-some=  | Notes linking to ANY of the given IDs   |
| =vulpea-db-query-by-links-every= | Notes linking to ALL of the given IDs   |
| =vulpea-db-query-by-meta=        | Notes where metadata key equals value   |
| =vulpea-db-query-by-meta-key=    | Notes having a specific metadata key    |
| =vulpea-db-query-by-level=       | Notes at specific heading level         |
| =vulpea-db-query-tags=           | Get list of all unique tags             |

*** Note Accessors

| Function                  | Description                     |
|---------------------------+---------------------------------|
| =vulpea-note-id=            | Get note's unique identifier    |
| =vulpea-note-path=          | Get note's file path            |
| =vulpea-note-title=         | Get note's title                |
| =vulpea-note-tags=          | Get note's tags (list)          |
| =vulpea-note-aliases=       | Get note's aliases (list)       |
| =vulpea-note-links=         | Get note's outgoing links       |
| =vulpea-note-meta=          | Get note's metadata (alist)     |
| =vulpea-note-level=         | Get heading level (0 = file)    |
| =vulpea-note-meta-get=      | Get first value of metadata key |
| =vulpea-note-meta-get-list= | Get all values of metadata key  |

*** Buffer Functions

| Function                   | Description                      |
|----------------------------+----------------------------------|
| =vulpea-buffer-title-get=    | Get title from current buffer    |
| =vulpea-buffer-title-set=    | Set title in current buffer      |
| =vulpea-buffer-tags-get=     | Get tags (file or heading level) |
| =vulpea-buffer-tags-set=     | Set tags (file or heading level) |
| =vulpea-buffer-tags-add=     | Add tags interactively           |
| =vulpea-buffer-tags-remove=  | Remove tags interactively        |
| =vulpea-buffer-alias-get=    | Get aliases from current note    |
| =vulpea-buffer-alias-add=    | Add an alias                     |
| =vulpea-buffer-alias-remove= | Remove an alias                  |
| =vulpea-buffer-meta-set=     | Set metadata value               |

*** Sync Functions

| Function                        | Description                              |
|---------------------------------+------------------------------------------|
| =vulpea-db-autosync-mode=         | Toggle automatic file watching           |
| =vulpea-db-sync-full-scan=        | Scan all directories (with =C-u= to force) |
| =vulpea-db-sync-update-file=      | Update single file                       |
| =vulpea-db-sync-update-directory= | Update entire directory                  |
| =vulpea-db-update-file=           | Immediate synchronous update             |

*** Utility Functions

| Function              | Description                        |
|-----------------------+------------------------------------|
| =vulpea-select=         | Select note with completion        |
| =vulpea-select-from=    | Select from provided note list     |
| =vulpea-title-to-slug=  | Convert title to URL-friendly slug |
| =vulpea-db-count-notes= | Count total notes in database      |

** Advanced Topics

*** Note Indexing Requirements

Vulpea only indexes notes that have an =ID= property in a property drawer.

**** File-Level Notes

#+begin_src org
:PROPERTIES:
:ID: 5093fc4e-8c63-4e60-a1da-83fc7ecd5db7
:END:
#+title: My Note

Content here...
#+end_src

**** Heading-Level Notes

#+begin_src org
,* My Heading
:PROPERTIES:
:ID: cfc39858-351d-4f1e-8f98-10d16d71f49e
:END:

Content here...
#+end_src

**** Excluding Notes from Indexing

Use =VULPEA_IGNORE= property:

#+begin_src org
:PROPERTIES:
:ID: some-uuid
:VULPEA_IGNORE: t
:END:
#+title: Private Note

This won't be indexed.
#+end_src

*** Writing Custom Plugins

Create custom extractors to add domain-specific data to the database:

#+begin_src emacs-lisp
;; Define extraction function
(defun my-extract-citations (ctx note-data)
  "Extract citations in format [@citekey] from notes."
  (let* ((ast (vulpea-parse-ctx-ast ctx))
         (note-id (plist-get note-data :id))
         (citations nil))
    ;; Extract citations from AST
    (org-element-map ast 'paragraph
      (lambda (para)
        (let ((content (org-element-interpret-data para)))
          (when (string-match "\\[@\\([^]]+\\)\\]" content)
            (push (match-string 1 content) citations)))))
    ;; Store in custom table
    (when citations
      (emacsql (vulpea-db)
               [:insert :into citations :values $v1]
               (mapcar (lambda (key) (vector note-id key))
                       (delete-dups citations))))
    note-data))

;; Register plugin with schema
(vulpea-db-register-extractor
 (make-vulpea-extractor
  :name 'citations
  :version 1
  :priority 50
  :schema '((citations
             [(note-id :not-null)
              (citekey :not-null)]
             (:primary-key [note-id citekey])
             (:foreign-key [note-id] :references notes [id]
              :on-delete :cascade)))
  :extract-fn #'my-extract-citations))
#+end_src

See [[file:docs/plugin-guide.org][Plugin Guide]] for comprehensive documentation.

*** Database Schema

Vulpea uses a hybrid schema with both materialized and normalized tables:

**** Materialized Notes Table

Complete note data in a single table for fast retrieval:

- =id= (primary key)
- =path=, =level=, =pos= (location)
- =title=, =aliases=, =tags=
- =properties=, =meta=, =links= (JSON)
- =todo=, =priority=, =scheduled=, =deadline=, =closed=
- =outline_path=, =attach_dir=
- =created_at=, =modified_at=

**** Normalized Tables for Queries

Indexed tables for efficient filtering:

- =tags= - (note_id, tag) with index on tag
- =links= - (source, dest, type) with indices on all columns
- =meta= - (note_id, key, value) with indices on key and value

**** Supporting Tables

- =file_hashes= - Track file changes (hash, mtime, size)
- =schema_registry= - Schema versioning for migrations

*** Architecture

**** Core Modules

- =vulpea-db.el= - Database layer, schema, core operations
- =vulpea-db-extract.el= - Parser, extractors, parse-once architecture
- =vulpea-db-query.el= - Query interface, all query functions
- =vulpea-db-sync.el= - File watching, async updates, external monitoring
- =vulpea.el= - High-level API (find, create, visit, insert)
- =vulpea-meta.el= - Metadata operations with type coercion
- =vulpea-buffer.el= - Buffer-local operations
- =vulpea-select.el= - Completion interface
- =vulpea-utils.el= - Utility functions

**** Design Principles

1. *Async-first*: File watchers + queue instead of save hooks
2. *Parse-once*: Single org-element parse shared across extractors
3. *Hybrid schema*: Materialized for reads, normalized for queries
4. *Smart detection*: Hash-based change detection skips unchanged files
5. *Extensible*: Plugin system for custom extractors and tables

See [[file:docs/architecture.org][Architecture Documentation]] for detailed design decisions and rationale.

*** Performance Characteristics

Actual benchmarks (MacBook Pro 2021, M1 Pro):

| Parse Method       | 1K notes | 10K notes | 100K notes | Throughput          |
|--------------------+----------+-----------+------------+---------------------|
| single-temp-buffer | 1.3s     | 8.9s      | 1.6min     | ~1k files/sec       |
| temp-buffer        | 2.2s     | 22s       | 30min      | ~460/sec (degrades) |
| find-file          | 26s      | 4.9min    | 102min     | ~34/sec (degrades)  |

Query performance (typical):

| Operation    | Time   | Scale      |
|--------------+--------+------------|
| Get by ID    | <5ms   | Any        |
| Tag query    | <50ms  | 100k notes |
| Link query   | <25ms  | 100k notes |
| Title search | <100ms | 100k notes |

See [[file:bench/PERFORMANCE.md][bench/PERFORMANCE.md]] for detailed benchmarks and optimization guide.

Performance tuning tips:

1. *Install =fd= and =fswatch=* (see Optional Dependencies) - biggest impact
2. Use =single-temp-buffer= if you don't need per-file hooks (fastest)
3. Disable heading-level indexing if not needed (2-3x speedup)
4. Guard heavy =org-mode-hook= functions to skip during parsing
5. Use =fswatch= for external monitoring (more efficient than polling)

** What's New in v2

v2 is a complete rewrite with breaking changes from v1.

*** Major Changes

**** No org-roam Dependency
- Completely independent library
- Custom database schema optimized for Vulpea's use cases
- No fragile advice-based integration

**** Async-First Architecture
- Non-blocking database updates via file watchers
- Handles external changes (git, sync tools)
- Batch processing with configurable delays
- Dual-mode: async for interactive, sync for programmatic

**** Performance Optimizations
- Hybrid database schema (materialized + normalized)
- Smart change detection (hash-based)
- Configurable heading-level indexing
- Parse-once architecture

**** Plugin System
- Custom extractors with parse context sharing
- Schema versioning and migrations
- Priority-based execution order
- Example plugins included

*** Breaking Changes from v1

1. *Database*: Different schema, not compatible with v1
2. *API*: Functions renamed and reorganized
3. *Metadata*: New format using =KEY_TYPE= convention
4. *Configuration*: Different customization variables
5. *Dependencies*: No org-roam, different requirements

Migration guide will be provided before official v2 release.

** Migration from v1

*‚ö†Ô∏è v2 is NOT backward compatible with v1.*

For now:
1. Keep v1 for production use
2. Test v2 separately
3. Wait for migration guide before switching

Migration utilities planned for v2 release.

** org-roam Compatibility

Vulpea v2 can coexist with org-roam, but they are independent systems with significant overlap.

*** Current Status

- *Separate databases*: Vulpea maintains its own SQLite database, independent from org-roam's
- *No integration*: Vulpea v2 does not enhance or extend org-roam functionality
- *Overlapping features*: Both provide note indexing, linking, and querying

*** Using Both Together

If you use both systems:

1. Both will index your notes independently
2. Database operations don't interfere with each other
3. You can use Vulpea's query API alongside org-roam's

*** Why No Compatibility Layer?

Vulpea v2 was designed as a standalone library because:

1. The author doesn't use org-roam features beyond the database (which v2 replaces)
2. It's unclear what a compatibility layer would provide
3. Both systems work independently without conflicts

*** Future Direction

We're open to adding compatibility features if users identify concrete needs. If you use both systems and have suggestions, please [[https://github.com/d12frosted/vulpea/issues][open an issue]] describing your use case.

** Troubleshooting

*** Notes Not Appearing in Database

*Symptom*: Files exist but =vulpea-db-query= returns empty or missing notes.

*Solutions*:
1. Ensure notes have =ID= properties (use =M-x org-id-get-create=)
2. Check =vulpea-db-sync-directories= includes your notes directory
3. Run =M-x vulpea-db-sync-full-scan= to rebuild the database
4. Verify files aren't excluded by =VULPEA_IGNORE= property

*** Slow Startup with Large Collections

*Symptom*: Emacs hangs when enabling =vulpea-db-autosync-mode=.

*Solutions*:
1. Set =vulpea-db-sync-scan-on-enable= to =nil= (skip initial scan)
2. Run =vulpea-db-sync-full-scan= manually after startup
3. Use =single-temp-buffer= parse method for faster syncing
4. Disable heading-level indexing if not needed: =(setq vulpea-db-index-heading-level nil)=
5. Install =fd= to ensure quick filesystem traversal

*** External Changes Not Detected

*Symptom*: Files modified by git/Dropbox/other tools aren't synced.

*Solutions*:
1. Install =fswatch= (recommended): =brew install fswatch= / =apt install fswatch=
2. Check =vulpea-db-sync-external-method= is set to ='auto= or ='fswatch=
3. Verify fswatch is running: check =*Messages*= for "Started fswatch monitoring"
4. As fallback, use polling: =(setq vulpea-db-sync-external-method 'poll)=

*** Database Corruption or Stale Data

*Symptom*: Queries return outdated information or errors.

*Solutions*:
1. Run =M-x vulpea-db-sync-full-scan= with =C-u= prefix to force rebuild
2. If issues persist, delete the database file and restart:
   #+begin_src emacs-lisp
   (delete-file vulpea-db-location)
   (vulpea-db-sync-full-scan)
   #+end_src

*** Performance Degrades Over Time

*Symptom*: Sync operations get slower with repeated use.

*Solutions*:
1. Switch to =single-temp-buffer= parse method if you don't need per-file hooks
2. Guard heavy =org-mode-hook= functions:
   #+begin_src emacs-lisp
   (add-hook 'org-mode-hook
             (lambda ()
               (unless (bound-and-true-p vulpea-db--active-parse-method)
                 ;; Your heavy hook code here
                 )))
   #+end_src
3. Restart Emacs periodically for very large collections (100k+)

*** Template Expansion Not Working

*Symptom*: =${var}= or =%(elisp)= placeholders appear literally in created notes.

*Solutions*:
1. Ensure you're using =vulpea-create=, not =org-capture= directly
2. Check template syntax: =${title}=, =%(user-full-name)=, =%<[%Y-%m-%d]>=
3. For elisp expressions, ensure they don't have unbalanced parentheses

** Development

*** Running Tests

#+begin_src bash
# Run all tests
eldev test

# Run specific test file
eldev test vulpea-db-query-test

# Run tests matching pattern
eldev test "vulpea-db-*"
#+end_src

*** Contributing

Contributions welcome! Areas where help is needed:

1. Performance testing with large note collections
2. Platform-specific testing (Windows, Linux, macOS)
3. Plugin development and examples
4. Documentation improvements
5. Bug reports and feature requests

** Real-World Usage

Projects using Vulpea v2:

- [[https://github.com/d12frosted/environment][d12frosted/environment]] - Personal Emacs configuration (13k+ notes)
- [[https://github.com/d12frosted/vino][d12frosted/vino]] - Wine cellar management with rich metadata

** Documentation

- [[file:docs/architecture.org][Architecture]] - Design decisions and rationale
- [[file:docs/plugin-guide.org][Plugin Guide]] - Writing custom extractors
- [[https://github.com/d12frosted/vulpea/tree/v2-rewrite][Source Code]] - v2-rewrite branch

** License

GPLv3

** Acknowledgments

Vulpea v2 builds on lessons learned from:
- org-roam's database design and community
- Vulpea v1's metadata system and real-world usage
- [[https://github.com/d12frosted/vino][vino]] (wine management) and [[https://github.com/d12frosted/environment][d12frosted/environment]] (personal notes)

Special thanks to the org-roam community for inspiration and feedback.
