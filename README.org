#+OPTIONS: toc:nil

* Vulpea
:PROPERTIES:
:ID:                     4897a1f9-10be-4489-a732-7daa4785d80f
:END:

#+begin_html
<p align="center">
  <img width="256px" src="./images/logo.png" alt="Banner">
</p>
<p align="center">
  <a href="https://github.com/d12frosted/vulpea/tree/v2-rewrite"><img alt="v2-rewrite branch" src="https://img.shields.io/badge/branch-v2--rewrite-blue"/></a>
  <a href="https://github.com/d12frosted/vulpea/actions"><img alt="Tests" src="https://img.shields.io/badge/tests-passing-green"/></a>
</p>
#+end_html

A high-performance, async-first note-taking library for Emacs. Vulpea provides a powerful database layer for org-mode notes with support for metadata, tags, links, and custom extractors. Designed to scale to 100k+ notes without blocking your workflow.

*Version 2.0* is a complete rewrite with no org-roam dependency, featuring async file watching, smart change detection, and a plugin system for extensibility.

** Installation

*Note:* v2 is currently on the =v2-rewrite= branch and not yet released to package archives.

*** From Source (Development)

#+begin_src bash
git clone https://github.com/d12frosted/vulpea
cd vulpea
git checkout v2-rewrite
#+end_src

Add to your Emacs configuration:

#+begin_src emacs-lisp
(add-to-list 'load-path "/path/to/vulpea")
(require 'vulpea)
#+end_src

*** Dependencies

- Emacs 27.2+
- =org-mode= 9.4.4+
- =emacsql= 4.3.0+ (with =emacsql-sqlite-builtin=)
- =s= 1.12+
- =dash= 2.19+

*** Optional Dependencies (Recommended)

For optimal performance, install these external tools:

**** =fd= - Fast Directory Scanning

Dramatically improves directory scanning speed (15x faster than =find=):

#+begin_src bash
# macOS
brew install fd

# Ubuntu/Debian
apt install fd-find

# Arch Linux
pacman -S fd
#+end_src

*Performance impact:* Scanning 13k files goes from ~580ms (=find=) to ~37ms (=fd=).

**** =fswatch= - External Change Detection

Reliably detects file changes from git pulls, Dropbox, etc.:

#+begin_src bash
# macOS
brew install fswatch

# Ubuntu/Debian
apt install fswatch

# Arch Linux
pacman -S fswatch
#+end_src

Without these tools, Vulpea falls back to slower but functional alternatives (=find= and polling).

** Quick Start

*** 1. Configure Directories

#+begin_src emacs-lisp
(require 'vulpea)

;; Set your notes directory
(setq vulpea-db-sync-directories '("~/org-roam/"))

;; Optional: configure database location
(setq vulpea-db-location
      (expand-file-name "vulpea.db" user-emacs-directory))
#+end_src

*** 2. Enable Auto-Sync

#+begin_src emacs-lisp
;; Enable automatic file watching and database updates
(vulpea-db-autosync-mode +1)
#+end_src

This starts monitoring your notes directory for changes and keeps the database up-to-date automatically.

*** 3. Ensure Notes Have IDs

Vulpea only indexes notes with =ID= properties. Add an ID to the beginning of your org files:

#+begin_src org
:PROPERTIES:
:ID: 5093fc4e-8c63-4e60-a1da-83fc7ecd5db7
:END:
#+title: My Note

Content here...
#+end_src

Use =M-x org-id-get-create= to add IDs interactively.

*** 4. Query Your Notes

#+begin_src emacs-lisp
;; Find notes with specific tags
(vulpea-db-query-by-tags-some '("project" "active"))

;; Get a note by ID
(vulpea-db-get-by-id "note-id-here")

;; Search by title
(vulpea-db-search-by-title "Meeting")
#+end_src

** Key Features

*** üöÄ Async-First Architecture
- Non-blocking database updates
- File watchers detect changes from Emacs, git, Dropbox, etc.
- Smart batching: 100 file changes = 1 transaction
- Dual-mode: async for interactive use, sync for programmatic operations

*** üìä Optimized Database
- Hybrid schema: materialized + normalized tables for optimal read performance
- Hash-based change detection skips parsing unchanged files
- Configurable heading-level indexing (disable for 2-3x speedup)
- Foreign key cascades for automatic cleanup

*** üîå Extensible Plugin System
- Parse-once architecture: single org-element parse shared across all extractors
- Custom database tables with schema versioning
- Priority-based execution order
- Example plugins included
- See [[file:docs/plugin-guide.org][Plugin Guide]] for details

*** üè∑Ô∏è Rich Metadata Support
- Type-aware metadata: =note=, =number=, =string=, =link=
- Tag-based queries with indexed lookups
- Link tracking with type filtering
- Full-text title search

*** ‚ö° Performance at Scale
- Designed for 100k+ notes
- Read-optimized queries
- Idle timer processing
- Configurable debouncing and batch sizes

** Usage Guide

*** Working with Notes

**** Finding Notes

#+begin_src emacs-lisp
;; Interactive note selection with completion
(vulpea-find)

;; Find notes linking to current note
(vulpea-find-backlink)

;; Insert a link to a note
(vulpea-insert)
#+end_src

**** Creating Notes

#+begin_src emacs-lisp
;; Create a new note programmatically
(vulpea-create "My New Note"
               :tags '("project" "work")
               :properties '(("STATUS" . "active"))
               :immediate-finish t)

;; Create with metadata
(vulpea-create "Wine Review"
               :meta '(("country" . "France")
                       ("rating" . "95")))
#+end_src

**** Visiting Notes

#+begin_src emacs-lisp
;; Visit a note by ID or note object
(vulpea-visit "note-id-123")

;; Visit in other window
(vulpea-visit note-object t)
#+end_src

*** Querying the Database

**** By Tags

#+begin_src emacs-lisp
;; Notes with ANY of these tags
(vulpea-db-query-by-tags-some '("wine" "red"))

;; Notes with ALL of these tags
(vulpea-db-query-by-tags-every '("project" "active"))

;; Notes WITHOUT these tags
(vulpea-db-query-by-tags-none '("archive" "deprecated"))
#+end_src

**** By Links

#+begin_src emacs-lisp
;; Notes linking to a specific ID
(vulpea-db-query-by-links-some '("note-id-123"))

;; Filter by link type
(vulpea-db-query-by-links-some '("note-id-123") "id")

;; Notes linking to ALL of these IDs
(vulpea-db-query-by-links-every '("id-1" "id-2"))
#+end_src

**** By Metadata

#+begin_src emacs-lisp
;; Notes with a specific metadata key
(vulpea-db-query-by-meta-key "country")

;; Notes where key equals value
(vulpea-db-query-by-meta "country" "France")

;; With type coercion (for note references)
(vulpea-db-query-by-meta "region" "region-id-123" "note")
#+end_src

**** By Level

#+begin_src emacs-lisp
;; File-level notes only (level 0)
(vulpea-db-query-by-level 0)

;; Heading-level notes (level > 0)
(vulpea-db-query-by-level 1)
#+end_src

**** Custom Queries

#+begin_src emacs-lisp
;; Query with custom predicate
(vulpea-db-query
 (lambda (note)
   (and (member "project" (vulpea-note-tags note))
        (string-prefix-p "2025" (vulpea-note-title note)))))
#+end_src

**** Statistics

#+begin_src emacs-lisp
(vulpea-db-count-notes)                    ; Total notes
(vulpea-db-count-file-level-notes)         ; File-level only
(vulpea-db-count-heading-level-notes)      ; Heading-level only
#+end_src

*** Working with Metadata

**** Defining Metadata

In your org file, use property drawer with =_TYPE= suffix:

#+begin_src org
:PROPERTIES:
:ID: wine-id-123
:country_string: France
:price_number: 45.99
:region_note: burgundy-id-456
:url_link: https://example.com
:END:
#+title: Ch√¢teau Margaux 2015
#+end_src

**** Reading Metadata

Vulpea provides two functions for reading metadata from notes:

- =vulpea-note-meta-get= - Get the first value of a metadata property
- =vulpea-note-meta-get-list= - Get all values when a property has multiple entries

Both functions support automatic type coercion:

- =string= (default) - Plain text value
- =number= - Converts string to number
- =symbol= - Interns string as symbol
- =link= - Extracts ID from =id:= links or returns raw link
- =note= - Resolves =id:= link to =vulpea-note= struct

***** Single Values

#+begin_src emacs-lisp
(let ((note (vulpea-db-get-by-id "wine-id-123")))
  ;; Get first value with type coercion
  (vulpea-note-meta-get note "country")              ; "France"
  (vulpea-note-meta-get note "price" 'number)        ; 45.99 (number)
  (vulpea-note-meta-get note "region" 'note)         ; <vulpea-note object>
  (vulpea-note-meta-get note "url" 'link))           ; "https://example.com"
#+end_src

***** Multiple Values

When a metadata property has multiple values, use =vulpea-note-meta-get-list=:

#+begin_src emacs-lisp
;; Example note with multiple grape varieties:
;; - grapes :: [[id:grape1][Cabernet Sauvignon]]
;; - grapes :: [[id:grape2][Merlot]]
;; - grapes :: [[id:grape3][Syrah]]

(let ((note (vulpea-db-get-by-id "wine-id-123")))
  ;; Get all grape varieties as notes
  (vulpea-note-meta-get-list note "grapes" 'note)
  ;; => (#s(vulpea-note :id "grape1" :title "Cabernet Sauvignon" ...)
  ;;     #s(vulpea-note :id "grape2" :title "Merlot" ...)
  ;;     #s(vulpea-note :id "grape3" :title "Syrah" ...))

  ;; Get all ratings as numbers
  (vulpea-note-meta-get-list note "ratings" 'number))
  ;; => (95 92 88)
#+end_src

**** Setting Metadata

#+begin_src emacs-lisp
;; In a note buffer
(vulpea-buffer-meta-set "status" "active" 'string)
(vulpea-buffer-meta-set "rating" "95" 'number)
(vulpea-buffer-meta-set "producer" "producer-id" 'note)
#+end_src

**** Managing Aliases

Vulpea provides functions to manage note aliases stored in the =ROAM_ALIASES= property:

#+begin_src emacs-lisp
;; Get current aliases
(vulpea-buffer-alias-get)
;; => ("Short Name" "Alternative Title")

;; Add a new alias
(vulpea-buffer-alias-add "New Alias")

;; Add an alias with spaces (automatically quoted)
(vulpea-buffer-alias-add "Alias With Spaces")

;; Remove an alias (with interactive completion)
(vulpea-buffer-alias-remove "Short Name")

;; Remove an alias programmatically
(vulpea-buffer-alias-remove "Alternative Title")
#+end_src

Key features:
- Automatic quoting of aliases containing spaces
- Duplicate detection (adding an existing alias is ignored)
- Interactive completion when removing aliases
- Automatically removes =ROAM_ALIASES= property when last alias is removed
- Properly parses mixed quoted and unquoted aliases

*** Synchronization

**** Manual Sync

#+begin_src emacs-lisp
;; Update a single file
(vulpea-db-sync-update-file "/path/to/note.org")

;; Update entire directory
(vulpea-db-sync-update-directory "~/org-roam/")

;; Full scan of all configured directories (smart detection)
(vulpea-db-sync-full-scan)

;; Force re-index (e.g., after changing configuration)
;; Interactive: M-x vulpea-db-sync-full-scan with C-u prefix
(vulpea-db-sync-full-scan 'force)
#+end_src

**** Programmatic Batch Operations

For creating many notes programmatically, use synchronous mode:

#+begin_src emacs-lisp
(vulpea-with-sync-db
  (dotimes (i 100)
    (vulpea-create (format "Note %d" i)
                   :tags '("generated")
                   :immediate-finish t)))
;; All updates complete before proceeding
#+end_src

** Configuration Reference

*** Database Settings

#+begin_src emacs-lisp
;; Database file location
(setq vulpea-db-location
      (expand-file-name "vulpea.db" user-emacs-directory))

;; Directories to watch and sync
(setq vulpea-db-sync-directories
      '("~/org-roam/" "~/notes/"))
#+end_src

*** Indexing Control

#+begin_src emacs-lisp
;; Disable heading-level indexing (2-3x faster)
(setq vulpea-db-index-heading-level nil)

;; Selective indexing with predicate
(setq vulpea-db-index-heading-level
      (lambda (path)
        (string-match-p "/daily/" path)))

;; Enable for all files (default)
(setq vulpea-db-index-heading-level t)
#+end_src

*** Sync Performance

#+begin_src emacs-lisp
;; Debounce delay before processing changes (seconds)
(setq vulpea-db-sync-batch-delay 2.0)

;; Maximum files per batch
(setq vulpea-db-sync-batch-size 100)

;; Idle timer delay (seconds)
(setq vulpea-db-sync-idle-delay 0.5)

;; Progress reporting interval (nil to disable)
(setq vulpea-db-sync-progress-interval 500)
#+end_src

*** Parsing Method

Choose the method for parsing org files:

#+begin_src emacs-lisp
;; Temp buffer: fast, recommended for most users (default)
(setq vulpea-db-parse-method 'temp-buffer)

;; Find file: slower but respects .dir-locals.el
;; Use this if you customize org-attach-id-dir via directory-local variables
(setq vulpea-db-parse-method 'find-file)
#+end_src

*Performance impact:* =temp-buffer= is 13-19x faster than =find-file=. The temp-buffer method provides correct behavior for standard configurations. Only use =find-file= if you have custom directory-local settings that affect org-attach behavior.

See =bench/PERFORMANCE.md= for detailed benchmarks.

*** External Change Detection

Choose how to detect changes made outside Emacs (git pulls, Dropbox sync, etc.):

#+begin_src emacs-lisp
;; Auto: try fswatch, fallback to polling (recommended)
(setq vulpea-db-sync-external-method 'auto)

;; FSWatch: requires 'fswatch' binary (most reliable)
(setq vulpea-db-sync-external-method 'fswatch)

;; Polling: pure Elisp, no dependencies
(setq vulpea-db-sync-external-method 'poll)
(setq vulpea-db-sync-poll-interval 2)  ; check every 2 seconds

;; Filenotify only: unreliable for external changes
(setq vulpea-db-sync-external-method nil)
#+end_src

Installing =fswatch= (recommended for reliability):

#+begin_src bash
# macOS
brew install fswatch

# Ubuntu/Debian
apt install fswatch

# Arch Linux
pacman -S fswatch
#+end_src

*** Startup Behavior

#+begin_src emacs-lisp
;; Control initial scan when enabling autosync-mode
;; nil: skip scan (fast startup, recommended)
(setq vulpea-db-sync-scan-on-enable nil)

;; 'async: queue files for async processing (non-blocking scan)
(setq vulpea-db-sync-scan-on-enable 'async)

;; 'blocking: scan and update synchronously (blocks until complete)
(setq vulpea-db-sync-scan-on-enable 'blocking)
#+end_src

*** File Name Templates

#+begin_src emacs-lisp
;; Template for new note filenames
(setq vulpea-file-name-template "${timestamp}_${slug}.org")

;; Available variables: ${title}, ${slug}, ${timestamp}, ${id}
;; Can also be a function:
(setq vulpea-file-name-template
      (lambda (title)
        (format "%s_%s.org"
                (format-time-string "%Y%m%d%H%M%S")
                (vulpea--title-to-slug title))))

;; Default directory for new notes
(setq vulpea-default-notes-directory "~/org-roam/")
#+end_src

** Advanced Topics

*** Note Indexing Requirements

Vulpea only indexes notes that have an =ID= property in a property drawer.

**** File-Level Notes

#+begin_src org
:PROPERTIES:
:ID: 5093fc4e-8c63-4e60-a1da-83fc7ecd5db7
:END:
#+title: My Note

Content here...
#+end_src

**** Heading-Level Notes

#+begin_src org
,* My Heading
:PROPERTIES:
:ID: cfc39858-351d-4f1e-8f98-10d16d71f49e
:END:

Content here...
#+end_src

**** Excluding Notes from Indexing

Use =VULPEA_IGNORE= property:

#+begin_src org
:PROPERTIES:
:ID: some-uuid
:VULPEA_IGNORE: t
:END:
#+title: Private Note

This won't be indexed.
#+end_src

*** Writing Custom Plugins

Create custom extractors to add domain-specific data to the database:

#+begin_src emacs-lisp
;; Define extraction function
(defun my-extract-citations (ctx note-data)
  "Extract citations in format [@citekey] from notes."
  (let* ((ast (vulpea-parse-ctx-ast ctx))
         (note-id (plist-get note-data :id))
         (citations nil))
    ;; Extract citations from AST
    (org-element-map ast 'paragraph
      (lambda (para)
        (let ((content (org-element-interpret-data para)))
          (when (string-match "\\[@\\([^]]+\\)\\]" content)
            (push (match-string 1 content) citations)))))
    ;; Store in custom table
    (when citations
      (emacsql (vulpea-db)
               [:insert :into citations :values $v1]
               (mapcar (lambda (key) (vector note-id key))
                       (delete-dups citations))))
    note-data))

;; Register plugin with schema
(vulpea-db-register-extractor
 (make-vulpea-extractor
  :name 'citations
  :version 1
  :priority 50
  :schema '((citations
             [(note-id :not-null)
              (citekey :not-null)]
             (:primary-key [note-id citekey])
             (:foreign-key [note-id] :references notes [id]
              :on-delete :cascade)))
  :extract-fn #'my-extract-citations))
#+end_src

See [[file:docs/plugin-guide.org][Plugin Guide]] for comprehensive documentation.

*** Database Schema

Vulpea uses a hybrid schema with both materialized and normalized tables:

**** Materialized Notes Table

Complete note data in a single table for fast retrieval:

- =id= (primary key)
- =path=, =level=, =pos= (location)
- =title=, =aliases=, =tags=
- =properties=, =meta=, =links= (JSON)
- =todo=, =priority=, =scheduled=, =deadline=, =closed=
- =outline_path=, =attach_dir=
- =created_at=, =modified_at=

**** Normalized Tables for Queries

Indexed tables for efficient filtering:

- =tags= - (note_id, tag) with index on tag
- =links= - (source, dest, type) with indices
- =meta= - (note_id, key, value, type) with indices

**** Supporting Tables

- =file_hashes= - Track file changes (hash, mtime, size)
- =schema_registry= - Schema versioning for migrations

*** Architecture

**** Core Modules

- =vulpea-db.el= - Database layer, schema, core operations
- =vulpea-db-extract.el= - Parser, extractors, parse-once architecture
- =vulpea-db-query.el= - Query interface, all query functions
- =vulpea-db-sync.el= - File watching, async updates, external monitoring
- =vulpea.el= - High-level API (find, create, visit, insert)
- =vulpea-meta.el= - Metadata operations with type coercion
- =vulpea-buffer.el= - Buffer-local operations
- =vulpea-select.el= - Completion interface
- =vulpea-utils.el= - Utility functions

**** Design Principles

1. *Async-first*: File watchers + queue instead of save hooks
2. *Parse-once*: Single org-element parse shared across extractors
3. *Hybrid schema*: Materialized for reads, normalized for queries
4. *Smart detection*: Hash-based change detection skips unchanged files
5. *Extensible*: Plugin system for custom extractors and tables

See [[file:docs/architecture.org][Architecture Documentation]] for detailed design decisions and rationale.

*** Performance Characteristics

Based on design targets (actual benchmarks pending):

| Operation | Target | Scale |
|-----------+--------+-------|
| Get by ID | <5ms | Any |
| Tag query | <50ms | 100k notes |
| Link query | <25ms | 100k notes |
| Title search | <100ms | 100k notes |
| Batch update (100 files) | <10s | Any |
| Full rebuild | <5min | 100k notes |

Performance tuning tips:

1. *Install =fd= and =fswatch=* (see Optional Dependencies) - biggest impact
2. Disable heading-level indexing if not needed (2-3x speedup)
3. Use =fswatch= for external monitoring (more efficient than polling)
4. Increase batch size for bulk operations
5. Adjust debounce delay based on your workflow

** What's New in v2

v2 is a complete rewrite with breaking changes from v1.

*** Major Changes

**** No org-roam Dependency
- Completely independent library
- Custom database schema optimized for Vulpea's use cases
- No fragile advice-based integration

**** Async-First Architecture
- Non-blocking database updates via file watchers
- Handles external changes (git, sync tools)
- Batch processing with configurable delays
- Dual-mode: async for interactive, sync for programmatic

**** Performance Optimizations
- Hybrid database schema (materialized + normalized)
- Smart change detection (hash-based)
- Configurable heading-level indexing
- Parse-once architecture

**** Plugin System
- Custom extractors with parse context sharing
- Schema versioning and migrations
- Priority-based execution order
- Example plugins included

*** Breaking Changes from v1

1. *Database*: Different schema, not compatible with v1
2. *API*: Functions renamed and reorganized
3. *Metadata*: New format using =KEY_TYPE= convention
4. *Configuration*: Different customization variables
5. *Dependencies*: No org-roam, different requirements

Migration guide will be provided before official v2 release.

** Migration from v1

*‚ö†Ô∏è v2 is NOT backward compatible with v1.*

For now:
1. Keep v1 for production use
2. Test v2 on a separate note collection
3. Wait for migration guide before switching

Migration utilities planned for v2 release.

** Development

*** Running Tests

#+begin_src bash
# Run all tests
eldev test

# Run specific test file
eldev test vulpea-db-query-test

# Run tests matching pattern
eldev test "vulpea-db-*"
#+end_src

*** Contributing

Contributions welcome! Areas where help is needed:

1. Performance testing with large note collections
2. Platform-specific testing (Windows, Linux, macOS)
3. Plugin development and examples
4. Documentation improvements
5. Bug reports and feature requests

** Real-World Usage

Projects using Vulpea v2:

- [[https://github.com/d12frosted/environment][d12frosted/environment]] - Personal Emacs configuration (13k+ notes)
- [[https://github.com/d12frosted/vino][d12frosted/vino]] - Wine cellar management with rich metadata

** Documentation

- [[file:docs/architecture.org][Architecture]] - Design decisions and rationale
- [[file:docs/plugin-guide.org][Plugin Guide]] - Writing custom extractors
- [[https://github.com/d12frosted/vulpea/tree/v2-rewrite][Source Code]] - v2-rewrite branch

** License

GPLv3

** Acknowledgments

Vulpea v2 builds on lessons learned from:
- org-roam's database design and community
- Vulpea v1's metadata system and real-world usage
- [[https://github.com/d12frosted/vino][vino]] (wine management) and [[https://github.com/d12frosted/environment][d12frosted/environment]] (personal notes)

Special thanks to the org-roam community for inspiration and feedback.
