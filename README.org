#+OPTIONS: toc:nil

* Vulpea v2
:PROPERTIES:
:ID:                     4897a1f9-10be-4489-a732-7daa4785d80f
:END:

#+begin_html
<p align="center">
  <img width="256px" src="./images/logo.png" alt="Banner">
</p>
<p align="center">
  <a href="https://github.com/d12frosted/vulpea/tree/v2-rewrite"><img alt="v2-rewrite branch" src="https://img.shields.io/badge/branch-v2--rewrite-blue"/></a>
  <a href="https://github.com/d12frosted/vulpea/actions"><img alt="Tests" src="https://img.shields.io/badge/tests-78%2F78%20passing-green"/></a>
</p>
#+end_html

*Version 2.0 - Complete Rewrite (In Development)*

A high-performance, async-first note-taking library for Emacs. v2 is a complete architectural rewrite designed for scalability, extensibility, and performance with 100k+ notes.

*âš ï¸ Breaking Change:* v2 removes the org-roam dependency and is a clean break from v1. See [[#migration][Migration Guide]] below.

** What's New in v2

*** Clean Break from org-roam
- *No org-roam dependency* - Vulpea v2 is completely independent
- *Custom database schema* optimized for read-heavy workloads
- *Parse-once architecture* - single org-element parse shared across all extractors
- *Plugin system* for extensibility without modifying core code

*** Async-First Architecture
- *Non-blocking updates* - UI never waits for database operations
- *File watchers* handle changes from git, Dropbox, etc.
- *Batch processing* - 100 file changes = 1 transaction
- *Dual-mode support* - async for interactive use, sync for programmatic operations

*** Performance Optimizations
- *Hybrid database schema* - materialized + normalized tables
- *Read-optimized queries* - single-table lookups for common operations
- *Configurable heading-level indexing* - disable for 2-3x performance improvement
- *Hash-based change detection* - skip parsing unchanged files
- *Designed for 100k+ notes* with excellent performance

** Architecture Overview

*** Database Layer (=vulpea-db.el=)
- SQLite via =emacsql-sqlite-builtin=
- Hybrid schema: materialized =notes= table + normalized =tags/links/meta= tables
- 6 tables, 9 indices
- Foreign key cascades for automatic cleanup
- Transaction support with rollback

*** Parser & Extractors (=vulpea-db-extract.el=)
- Parse context shared across all extractors
- org-element-based parsing
- Core extractors: notes, tags, links, metadata
- Metadata type coercion: =note=, =number=, =string=, =link=
- Extractor registry for plugins

*** File Watching & Sync (=vulpea-db-sync.el=)
- Internal: filenotify-based watchers
- External: fswatch process or polling fallback
- Async update queue with batching
- Debouncing (2s delay, configurable)
- Batch processing (100 files/batch)
- Idle timer processing (0.5s delay)
- Auto-restart for crashed fswatch processes

*** Query Layer (=vulpea-db-query.el=)
- Hybrid query strategy: materialized + normalized tables
- Core queries: get-by-id, query-all with predicate
- Tag queries: by-tags-some/every/none (indexed lookups)
- Link queries: by-links-some/every with type filtering
- Meta queries: by-meta-key, by-meta with type support
- Level queries: file-level vs heading-level notes
- Title search: case-sensitive and case-insensitive
- Statistics: count-notes, count by level

** Current Status

*** âœ… Implemented (Phases 1-4)
- [X] Database Core (11 tests passing)
- [X] Parser & Extractors (18 tests passing)
- [X] File Watching & Async Updates (12 tests passing)
- [X] Query Layer & High-Level API (30 tests passing)
- *Total: 78/78 tests passing (100%)*

*** ðŸš§ In Progress
- [ ] Plugin system refinement
- [ ] Performance testing & optimization

*** ðŸ“… Planned
- [ ] Migration utilities from v1
- [ ] Documentation & examples
- [ ] Integration tests with real-world note collections

** Installation (Development)

*Note:* v2 is currently on the =v2-rewrite= branch and not yet released.

#+begin_src bash
# Clone and checkout v2 branch
git clone https://github.com/d12frosted/vulpea
cd vulpea
git checkout v2-rewrite

# Run tests
eldev test
#+end_src

** Basic Usage (Current API)

*** Initialize Database

#+begin_src emacs-lisp
(require 'vulpea-db)

;; Initialize database (creates schema)
(vulpea-db)

;; Clear database if needed
(vulpea-db-clear)
#+end_src

*** Parse and Update Files

#+begin_src emacs-lisp
(require 'vulpea-db-extract)

;; Parse a single file
(vulpea-db-update-file "/path/to/note.org")

;; Parse with context (for plugins)
(let ((ctx (vulpea-db--parse-file "/path/to/note.org")))
  ;; Access parsed data
  (vulpea-parse-ctx-file-node ctx)
  (vulpea-parse-ctx-heading-nodes ctx))
#+end_src

*** Enable Auto-Sync

#+begin_src emacs-lisp
(require 'vulpea-db-sync)

;; Configure directories to watch
(setq vulpea-db-sync-directories
      '("~/org-roam/"))

;; Enable automatic file watching and async updates
(vulpea-db-autosync-mode +1)

;; Manually update a file (queues if autosync enabled)
(vulpea-db-sync-update-file (buffer-file-name))

;; Update entire directory
(vulpea-db-sync-update-directory "~/org-roam/")
#+end_src

*Note:* By default, autosync uses filenotify which may not detect external changes (git pulls, Dropbox sync). See [[#external-monitoring][External Change Detection]] for reliable monitoring.

**** External Change Detection
:PROPERTIES:
:CUSTOM_ID: external-monitoring
:END:

Vulpea supports three methods for detecting external file changes:

1. *Auto (Recommended)*

   Tries =fswatch= first, falls back to polling if unavailable:

   #+begin_src emacs-lisp
   (setq vulpea-db-sync-external-method 'auto)  ; default
   #+end_src

2. *FSWatch (Most Reliable)*

   Uses external =fswatch= process for real-time monitoring:

   #+begin_src bash
   # Install fswatch first
   brew install fswatch  # macOS
   apt install fswatch   # Ubuntu/Debian
   #+end_src

   #+begin_src emacs-lisp
   (setq vulpea-db-sync-external-method 'fswatch)
   #+end_src

   Features:
   - Real-time change detection
   - Low CPU usage
   - Auto-restart if process dies
   - Filters out temporary/backup files

3. *Polling (No Dependencies)*

   Pure Elisp fallback using mtime comparison:

   #+begin_src emacs-lisp
   (setq vulpea-db-sync-external-method 'poll)
   (setq vulpea-db-sync-poll-interval 2)  ; check every 2 seconds
   #+end_src

4. *Filenotify Only (Unreliable)*

   #+begin_src emacs-lisp
   (setq vulpea-db-sync-external-method nil)  ; not recommended
   #+end_src

   Only detects changes from within Emacs. External changes (git, sync tools) may be missed on some systems.

*** Query Notes

#+begin_src emacs-lisp
(require 'vulpea-db-query)

;; Get note by ID
(vulpea-db-get-by-id "note-id-123")

;; Query all notes
(vulpea-db-query)

;; Query with predicate
(vulpea-db-query
 (lambda (note)
   (and (member "wine" (vulpea-note-tags note))
        (= (vulpea-note-level note) 0))))

;; Tag queries
(vulpea-db-query-by-tags-some '("wine" "red"))    ; notes with ANY tag
(vulpea-db-query-by-tags-every '("wine" "red"))   ; notes with ALL tags
(vulpea-db-query-by-tags-none '("archive"))       ; notes without tags

;; Link queries
(vulpea-db-query-by-links-some '("note-id-123"))        ; notes linking to ID
(vulpea-db-query-by-links-some '("note-id") "id")       ; filter by link type
(vulpea-db-query-by-links-every '("id1" "id2"))         ; links to all IDs

;; Metadata queries
(vulpea-db-query-by-meta-key "country")                 ; notes with key
(vulpea-db-query-by-meta "country" "France")            ; key = value
(vulpea-db-query-by-meta "region" "id-123" "note")      ; with type filter

;; Other queries
(vulpea-db-query-by-level 0)                      ; file-level notes only
(vulpea-db-search-by-title "Wine")                ; search by title
(vulpea-db-search-by-title "Wine" t)              ; case-sensitive

;; Statistics
(vulpea-db-count-notes)                           ; total notes
(vulpea-db-count-file-level-notes)                ; level 0 notes
(vulpea-db-count-heading-level-notes)             ; level > 0 notes
#+end_src

*** Synchronous Batch Operations

#+begin_src emacs-lisp
;; For programmatic note creation
(vulpea-with-sync-db
  ;; Creates 100 notes synchronously
  (dotimes (i 100)
    (let ((path (format "~/org-roam/note-%d.org" i)))
      (with-temp-file path
        (insert (format "#+TITLE: Note %d\n#+ID: %s\n"
                        i (org-id-new))))
      (vulpea-db-update-file path))))
;; All updates complete before proceeding
#+end_src

*** Metadata with Type Coercion

#+begin_src emacs-lisp
;; In your org file:
;; :PROPERTIES:
;; :country_string: France
;; :price_number: 25.50
;; :region_note: region-id-123
;; :url_link: https://example.com
;; :END:

;; Metadata is extracted with types:
;; '(("country" . ((:value "France" :type "string")))
;;   ("price" . ((:value "25.50" :type "number")))
;;   ("region" . ((:value "region-id-123" :type "note")))
;;   ("url" . ((:value "https://example.com" :type "link"))))
#+end_src

*** Register Custom Extractor

#+begin_src emacs-lisp
(vulpea-db-register-extractor
 'my-citations
 (lambda (ctx note-data)
   ;; Extract citations from parse context
   ;; Add to note-data
   (plist-put note-data :citations (my-extract-citations ctx))
   note-data))
#+end_src

** Configuration

#+begin_src emacs-lisp
;; Database location
(setq vulpea-db-location
      (expand-file-name "vulpea.db" user-emacs-directory))

;; Heading-level indexing (disable for performance)
(setq vulpea-db-index-heading-level nil)  ; 2-3x faster

;; Or selective indexing
(setq vulpea-db-index-heading-level
      (lambda (path)
        (string-match-p "/daily/" path)))

;; Sync settings
(setq vulpea-db-sync-batch-delay 2.0)     ; Debounce delay (seconds)
(setq vulpea-db-sync-batch-size 100)      ; Max files per batch
(setq vulpea-db-sync-idle-delay 0.5)      ; Idle timer delay

;; External change detection
(setq vulpea-db-sync-external-method 'auto)  ; auto, fswatch, poll, or nil
(setq vulpea-db-sync-poll-interval 2)        ; Polling interval (if used)
#+end_src

** Design Documentation

Comprehensive design documentation is available in =docs/=:

- [[file:docs/v2-architecture-decisions.org][Architecture Decisions]] - 11 key decisions with rationale
- [[file:docs/v2-usage-analysis.org][Usage Analysis]] - Real-world usage patterns from vino and d12frosted/environment
- [[file:docs/v2-implementation-guide.org][Implementation Guide]] - Step-by-step implementation details

** Performance Targets

Based on real-world usage with 10k+ notes:

| Operation | Target | Status |
|-----------+--------+--------|
| Tag query (10k notes) | <50ms | âœ… Implemented, not yet benchmarked |
| Get note by ID | <5ms | âœ… Implemented, not yet benchmarked |
| File update (agenda) | <200ms | âœ… Implemented, not yet benchmarked |
| Batch update (100 files) | <10s | âœ… Implemented, not yet benchmarked |
| Database rebuild (10k) | <60s | ðŸš§ Not yet measured |

** Migration from v1
:PROPERTIES:
:ID: migration
:END:

*âš ï¸ v2 is NOT backward compatible with v1.*

Key breaking changes:

1. *No org-roam dependency* - v2 uses its own database
2. *Different API* - functions renamed and reorganized
3. *New metadata format* - uses =KEY_TYPE= convention
4. *Configuration changes* - different customization variables

Migration utilities will be provided before v2 release. For now:

1. Keep v1 installation for production use
2. Test v2 on separate note collection
3. Wait for migration guide before switching

** Contributing

v2 is under active development. Contributions welcome:

1. Test with your note collection and report issues
2. Review architecture decisions and provide feedback
3. Help with performance testing and optimization
4. Improve documentation and examples
5. Develop plugin system and custom extractors

** Users of This Library

- [[https://github.com/d12frosted/environment][d12frosted/environment]] - Emacs configurations (10k+ notes)
- [[https://github.com/d12frosted/vino][d12frosted/vino]] - Wine cellar tracking with metadata type coercion

** License

GPLv3

** Acknowledgments

v2 builds on lessons learned from:
- org-roam's database design
- vulpea v1's metadata system
- Real-world usage in vino (wine management) and d12frosted/environment (10k+ notes)

Special thanks to the org-roam community for inspiration and feedback.
